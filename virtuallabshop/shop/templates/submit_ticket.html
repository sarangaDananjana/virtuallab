<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    {% load static %}
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Open Support Ticket — Virtual Lab Games</title>
    <meta name="description"
        content="Open a support ticket with Virtual Lab Games. Tell us the issue and preferred time — we'll help you get playing again fast." />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#F1F7FF', 100: '#DDEBFF', 200: '#B8D5FF', 300: '#90BDFF', 400: '#5EA1FF', 500: '#2D86FF', 600: '#1E6CE0', 700: '#164FB3', 800: '#0E377F', 900: '#0A2559' },
                        gold: { 50: '#FFFBEB', 100: '#FEF3C7', 200: '#FDE68A', 300: '#FCD34D', 400: '#f6cd45', 500: '#F59E0B', 600: '#D97706', 700: '#B45309', 800: '#92400E', 900: '#78350F' }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'gradient': 'gradient 8s ease infinite',
                    },
                    keyframes: {
                        float: { '0%,100%': { transform: 'translateY(0px)' }, '50%': { transform: 'translateY(-20px)' } },
                        gradient: { '0%,100%': { 'background-position': '0% 50%' }, '50%': { 'background-position': '100% 50%' } }
                    }
                }
            }
        }
    </script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600;700&family=Maname&display=swap"
        rel="stylesheet">

    <!-- Shared site styles for aurora bg, glass, header blend, noise, Sinhala helpers -->
    <link rel="stylesheet" href="{% static 'css/home.css' %}">

    <style>
        /* Language helpers (same as other pages) */
        .lang-si {
            display: none;
        }

        body.sinhala-mode .lang-en {
            display: none;
        }

        body.sinhala-mode .lang-si {
            display: inline;
        }

        .block-lang.lang-si {
            display: none;
        }

        body.sinhala-mode .block-lang.lang-en {
            display: none;
        }

        body.sinhala-mode .block-lang.lang-si {
            display: block;
        }

        /* Selected-state styling for option & slot labels */
        .option,
        .slot-label {
            transition: background .2s, border-color .2s, box-shadow .2s, transform .1s;
        }

        .option:has(input:checked),
        .slot-label:has(input:checked),
        .option.selected,
        .slot-label.selected {
            background: rgba(45, 134, 255, .12);
            border-color: rgba(94, 161, 255, .7);
            box-shadow: 0 0 0 2px rgba(45, 134, 255, .35), inset 0 0 0 1px rgba(255, 255, 255, .12);
        }

        .checkmark {
            margin-left: auto;
            width: 22px;
            height: 22px;
            border-radius: 9999px;
            background: rgba(45, 134, 255, .95);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #000;
            opacity: 0;
            transform: scale(.85);
            transition: opacity .15s, transform .15s;
        }

        .option:has(input:checked) .checkmark,
        .slot-label:has(input:checked) .checkmark,
        .option.selected .checkmark,
        .slot-label.selected .checkmark {
            opacity: 1;
            transform: scale(1);
        }

        /* Slots */
        .slot-label {
            position: relative;
        }

        .slot-time {
            letter-spacing: -0.01em;
            white-space: nowrap;
        }

        .slot-ampm {
            text-transform: uppercase;
            opacity: .7;
            font-size: .75rem;
            line-height: 1rem;
        }

        .slot-label.unavailable {
            opacity: .65;
            border-style: dashed;
            border-color: rgba(239, 68, 68, .5);
            background-image: linear-gradient(135deg, rgba(239, 68, 68, .06), transparent 40%);
        }

        .slot-label.unavailable .slot-time {
            text-decoration: line-through;
        }

        .unavailable-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            padding: 2px 6px;
            border-radius: 9999px;
            font-size: 10px;
            line-height: 1;
            background: rgba(239, 68, 68, .15);
            color: #fecaca;
            border: 1px solid rgba(239, 68, 68, .3);
            pointer-events: none;
        }

        /* Photos */
        .photo-slot {
            aspect-ratio: 1/1;
        }

        .photo-slot .photo-empty {
            transition: opacity .15s;
        }

        .photo-slot:hover .photo-empty {
            opacity: .85;
        }
    </style>
</head>

<body class="bg-aurora text-white selection:bg-gold-400/30 selection:text-white noise">
    <!-- Header (consistent with site; mobile shows only logo + language toggle + hamburger) -->
    <header class="header-blend">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16 sm:h-18">
                <!-- Logo -->
                <a href="{% url 'home-page' %}" class="flex items-center gap-2 sm:gap-3">
                    <img src="{% static 'images/Virtuallab.png' %}" alt="Virtual Lab logo"
                        class="h-10 sm:h-12 w-auto object-contain" width="48" height="48" decoding="async" />
                    <div class="flex flex-col">
                        <span class="font-black text-base sm:text-lg lg:text-xl tracking-tight">Virtual Lab</span>
                        <span class="text-[10px] sm:text-xs font-medium -mt-0.5">GAMES</span>
                    </div>
                </a>

                <!-- Right controls -->
                <div class="flex items-center gap-2 sm:gap-3">
                    <!-- Language Toggle (always visible) -->
                    <button id="langToggleBtn"
                        class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-white/10 hover:bg-white/15 text-sm font-bold transition-all">EN</button>

                    <!-- Desktop actions (hidden on mobile) -->
                    <a href="{% url 'cart_page' %}"
                        class="hidden lg:inline-flex shine items-center gap-2 px-3 sm:px-5 py-2 rounded-xl bg-gradient-to-r from-brand-500 to-gold-400 text-white text-sm font-bold shadow-lg hover:shadow-xl transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2 9m13-9l2 9M10 21a1 1 0 100-2 1 1 0 000 2zm8 0a1 1 0 100-2 1 1 0 000 2z" />
                        </svg>
                        <span class="lang-en">Cart</span><span class="lang-si">Cart</span>
                    </a>
                    <a href="{% url 'shop-page' %}"
                        class="hidden lg:inline-flex store-pop shine items-center gap-2 px-3 sm:px-5 py-2 rounded-xl bg-gradient-to-r from-brand-500 to-gold-400 text-white text-sm font-bold shadow-lg hover:shadow-xl transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                        </svg>
                        <span class="lang-en">Store</span><span class="lang-si">වෙළඳසැල</span>
                    </a>
                    {% if user.is_authenticated %}
                    <a href="{% url 'profile-page' %}" aria-label="Account"
                        class="hidden lg:inline-flex items-center justify-center w-10 h-10 rounded-xl bg-white/10 hover:bg-white/15 font-bold uppercase transition-all">
                        {{user_initial }}</a>
                    {% else %}
                    <a href="{% url 'login-page' %}"
                        class="hidden lg:inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15 text-sm font-semibold transition-all"><span
                            class="lang-en">Login</span><span class="lang-si">ඇතුළු වන්න</span></a>
                    {% endif %}

                    <!-- Mobile nav toggle (only icon on mobile) -->
                    <button id="navToggle"
                        class="lg:hidden p-2 rounded-lg bg-white/10 hover:bg-white/15 transition-colors"
                        aria-label="Open menu">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Menu: Login/Register, Store, My Tickets + Language -->
        <div id="mobileMenu" class="lg:hidden hidden border-t border-gray-200/50 bg-white/95 backdrop-blur-xl">
            <div class="container mx-auto px-4 py-4 space-y-2 text-gray-800">
                {% if user.is_authenticated %}
                <div class="flex items-center gap-3 px-4 py-3 rounded-lg bg-gray-900/5">
                    <div
                        class="flex items-center justify-center w-10 h-10 rounded-lg bg-gradient-to-br from-brand-500/20 to-gold-400/20 font-bold uppercase text-gray-800">
                        {{ user_initial }}</div>
                    <div class="text-sm"><span class="lang-en">Hello</span><span class="lang-si">ආයුබෝවන්</span>, {{
                        user.username }}</div>
                </div>
                {% else %}
                <a href="{% url 'login-page' %}"
                    class="block px-4 py-2 rounded-lg hover:bg-gray-900/5 transition-colors"><span
                        class="lang-en">Login</span><span class="lang-si">ඇතුළු වන්න</span></a>
                <a href="{% url 'register-page' %}"
                    class="block px-4 py-2 rounded-lg hover:bg-gray-900/5 transition-colors"><span
                        class="lang-en">Register</span><span class="lang-si">ලියාපදිංචි වන්න</span></a>
                {% endif %}

                <a href="{% url 'shop-page' %}"
                    class="block px-4 py-2 rounded-lg hover:bg-gray-900/5 transition-colors"><span
                        class="lang-en">Store</span><span class="lang-si">වෙළඳසැල</span></a>
                <a href="{% url 'tickets-page' %}"
                    class="block px-4 py-2 rounded-lg hover:bg-gray-900/5 transition-colors"><span class="lang-en">My
                        Tickets</span><span class="lang-si">මගේ ටිකට්</span></a>

                <button id="langToggleBtnMobile"
                    class="block w-full text-left px-4 py-2 rounded-lg hover:bg-gray-900/5 transition-colors font-bold">EN</button>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main class="py-10 sm:py-14 lg:py-16">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-4xl">

            <!-- Title -->
            <div class="mb-6 sm:mb-8">
                <div
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-full glass text-xs sm:text-sm font-semibold">
                    <span class="relative flex h-2 w-2"><span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span
                            class="relative inline-flex rounded-full h-2 w-2 bg-emerald-400"></span></span>
                    <span class="lang-en">Support • Submit a Ticket</span><span class="lang-si">සහාය • ටිකට් එකක්
                        යවන්න</span>
                </div>
                <h1 class="mt-4 text-3xl sm:text-4xl lg:text-5xl font-black">
                    <span class="block block-lang lang-en">Open a Support Ticket</span>
                    <span class="block block-lang lang-si">සහාය ටිකට් එකක් අරඹන්න</span>
                </h1>
                <p class="mt-2 text-white/70"><span class="lang-en">Tell us what went wrong. We'll get back to you
                        within 24 hours.</span><span class="lang-si">ඔබට ගැටලුව පිලිබඳව අපට කියන්න. පැය 24 තුළ පිළිතුරක්
                        ලැබේ.</span></p>
            </div>

            <!-- Stepper -->
            <div class="glass rounded-2xl sm:rounded-3xl p-4 sm:p-6 mb-6">
                <ol class="grid grid-cols-1 sm:grid-cols-4 gap-3">
                    <li class="step-bullet active flex items-center gap-3"><span
                            class="w-8 h-8 rounded-full bg-brand-500 text-black font-black flex items-center justify-center">1</span><span
                            class="text-sm"><span class="lang-en">Source</span><span
                                class="lang-si">මූලාශ්‍රය</span></span></li>
                    <li class="step-bullet flex items-center gap-3"><span
                            class="w-8 h-8 rounded-full bg-white/10 font-black flex items-center justify-center">2</span><span
                            class="text-sm"><span class="lang-en">Order</span><span class="lang-si">ඇණවුම</span></span>
                    </li>
                    <li class="step-bullet flex items-center gap-3"><span
                            class="w-8 h-8 rounded-full bg-white/10 font-black flex items-center justify-center">3</span><span
                            class="text-sm"><span class="lang-en">Details</span><span
                                class="lang-si">විස්තර</span></span></li>
                    <li class="step-bullet flex items-center gap-3"><span
                            class="w-8 h-8 rounded-full bg-white/10 font-black flex items-center justify-center">4</span><span
                            class="text-sm"><span class="lang-en">Review</span><span
                                class="lang-si">සමාලෝචනය</span></span></li>
                </ol>
            </div>

            <!-- Form -->
            <form id="ticketForm" action="{% url 'ticket-submit' %}" method="post" enctype="multipart/form-data"
                class="space-y-6">
                {% csrf_token %}

                <!-- STEP 1: Source -->
                <section class="step-panel glass rounded-2xl sm:rounded-3xl p-5 sm:p-6">
                    <h2 class="text-xl font-bold mb-4"><span class="lang-en">Where did this order come from?</span><span
                            class="lang-si">මෙම ඇණවුම කොහින්ද ආවේ?</span></h2>
                    <div class="grid sm:grid-cols-2 gap-4">
                        <!-- Virtual Lab -->
                        <label
                            class="option relative flex items-center gap-3 p-4 rounded-xl bg-white/5 border border-white/10 cursor-pointer hover:bg-white/10">
                            <input type="radio" name="source" value="VIRTUAL_LAB" class="sr-only" />
                            <img src="{% static 'images/logo.png' %}" alt="Virtual Lab"
                                class="w-10 h-10 rounded-xl ring-1 ring-white/10 bg-white/10 object-contain p-1" />
                            <div>
                                <div class="font-semibold"><span class="lang-en">Virtual Lab website</span><span
                                        class="lang-si">Virtual Lab වෙබ්අඩවිය</span></div>
                                <div class="text-sm text-white/60"><span class="lang-en">Select from your previous
                                        orders</span><span class="lang-si">ඔබගේ කලින් ඇණවුම් අතරින් තෝරන්න</span></div>
                            </div>
                            <span class="checkmark" aria-hidden="true"><svg viewBox="0 0 20 20" class="w-3.5 h-3.5"
                                    fill="none" stroke="currentColor" stroke-width="3">
                                    <path d="M4 10l4 4 8-8" />
                                </svg></span>
                        </label>
                        <!-- Daraz -->
                        <label
                            class="option relative flex items-center gap-3 p-4 rounded-xl bg-white/5 border border-white/10 cursor-pointer hover:bg-white/10">
                            <input type="radio" name="source" value="DARAZ" class="sr-only" />
                            <img src="{% static 'images/Daraz.png' %}" alt="Daraz"
                                class="w-10 h-10 rounded-xl ring-1 ring-white/10 bg-white/10 object-contain p-1" />
                            <div>
                                <div class="font-semibold">Daraz</div>
                                <div class="text-sm text-white/60"><span class="lang-en">Enter Daraz order
                                        details</span><span class="lang-si">Daraz ඇණවුම් විස්තර යොදන්න</span></div>
                            </div>
                            <span class="checkmark" aria-hidden="true"><svg viewBox="0 0 20 20" class="w-3.5 h-3.5"
                                    fill="none" stroke="currentColor" stroke-width="3">
                                    <path d="M4 10l4 4 8-8" />
                                </svg></span>
                        </label>
                    </div>
                    <div class="mt-5 flex justify-end gap-3">
                        <button type="button"
                            class="btn-next shine px-5 py-2.5 rounded-xl bg-gradient-to-r from-brand-500 to-gold-400 text-white font-bold"><span
                                class="lang-en">Next</span><span class="lang-si">ඊළඟට</span></button>
                    </div>
                </section>

                <!-- STEP 2: Order info -->
                <section class="step-panel glass rounded-2xl sm:rounded-3xl p-5 sm:p-6 hidden">
                    <h2 class="text-xl font-bold mb-4"><span class="lang-en">Order Details</span><span
                            class="lang-si">ඇණවුම් විස්තර</span></h2>
                    <!-- Virtual Lab orders selector -->
                    <div id="vlOrderBlock" class="space-y-3 hidden">
                        <label class="block text-sm font-medium"><span class="lang-en">Select your order</span><span
                                class="lang-si">ඔබගේ ඇණවුම තෝරන්න</span></label>
                        <select name="order_id" id="orderSelect"
                            class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:border-brand-400"
                            required>
                            <option value=""><span class="lang-en">— Choose an order —</span></option>
                            {% for order in orders %}
                            <option value="{{ order.id }}">Order #{{ order.id }} — {{ order.ordered_at|date:"Y-m-d" }} —
                                {{ order.get_status_display }}</option>
                            {% empty %}
                            <option value="" disabled><span class="lang-en">No orders found on your account</span><span
                                    class="lang-si">ඔබගේ ගිණුමට ඇණවුම් හමු නොවීය</span></option>
                            {% endfor %}
                        </select>
                        <p class="text-xs text-white/60"><span class="lang-en">Can’t find your order? Choose Daraz in
                                the previous step if it’s from Daraz.</span><span class="lang-si">ඔබගේ ඇණවුම හමු නොවන්නේ
                                නම්, පෙර පියවරෙන් Daraz තෝරන්න.</span></p>
                    </div>
                    <!-- Daraz fields -->
                    <div id="darazBlock" class="grid sm:grid-cols-2 gap-4 hidden">
                        <div>
                            <label class="block text-sm font-medium mb-2"><span class="lang-en">Daraz Order
                                    Number</span><span class="lang-si">Daraz ඇණවුම් අංකය</span></label>
                            <input name="daraz_order_number" type="text"
                                class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:border-brand-400"
                                placeholder="e.g., 1234567890" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2"><span class="lang-en">Daraz Order
                                    Date</span><span class="lang-si">Daraz ඇණවුම් දිනය</span></label>
                            <input name="daraz_order_date" type="date"
                                class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:border-brand-400" />
                        </div>
                    </div>
                    <div class="mt-5 flex justify-between gap-3">
                        <button type="button"
                            class="btn-prev px-5 py-2.5 rounded-xl bg-white/10 hover:bg-white/15 font-semibold"><span
                                class="lang-en">Back</span><span class="lang-si">ආපසු</span></button>
                        <button type="button"
                            class="btn-next shine px-5 py-2.5 rounded-xl bg-gradient-to-r from-brand-500 to-gold-400 text-white font-bold"><span
                                class="lang-en">Next</span><span class="lang-si">ඊළඟට</span></button>
                    </div>
                </section>

                <!-- STEP 3: Issue details & uploads -->
                <section class="step-panel glass rounded-2xl sm:rounded-3xl p-5 sm:p-6 hidden">
                    <h2 class="text-xl font-bold mb-4"><span class="lang-en">Issue Details</span><span
                            class="lang-si">බැරෑරුම් විස්තර</span></h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2"><span class="lang-en">Subject (max 100
                                    chars)</span><span class="lang-si"> මාතෘකාව (අක්ෂර 100)</span></label>
                            <input name="subject" id="subject" maxlength="100" required
                                class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:border-brand-400"
                                placeholder="Brief summary of the issue" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2"><span class="lang-en">Description</span><span
                                    class="lang-si">විස්තරය</span></label>
                            <textarea name="description" id="description" rows="6" required
                                class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:border-brand-400"
                                placeholder="Explain the problem in detail..."></textarea>
                        </div>
                        <div class="grid sm:grid-cols-2 gap-4">
                            <!-- Video -->
                            <div>
                                <label class="block text-sm font-medium mb-2"><span class="lang-en">Video (optional, ≤ 2
                                        minutes)</span><span class="lang-si">වීඩියෝ (විකල්ප, විනාඩි 2ට
                                        අඩු)</span></label>
                                <input id="videoInput" name="video" type="file" accept="video/*"
                                    class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-white/10 file:text-white hover:file:bg-white/20" />
                                <p id="videoHint" class="text-xs text-white/50 mt-2"><span class="lang-en">Accepted:
                                        mp4, mov, m4v, webm, avi • Max length 2:00</span><span class="lang-si">ඉඩදෙන
                                        මාදිලි: mp4, mov, m4v, webm, avi • උපරිම කාලය 2:00</span></p>
                                <video id="videoPreview" class="mt-3 rounded-lg w-full hidden" controls></video>
                            </div>
                            <!-- Photos (5 slots) -->
                            <div>
                                <label class="block text-sm font-medium mb-2"><span class="lang-en">Photos (up to
                                        5)</span><span class="lang-si">ඡායාරූප (උපරිම 5)</span></label>
                                <div id="photosGrid" class="grid grid-cols-5 gap-2">
                                    {% for i in "12345" %}
                                    <label
                                        class="photo-slot relative block rounded-lg bg-white/5 border border-white/10 overflow-hidden cursor-pointer">
                                        <input id="photo{{ forloop.counter }}" class="photo-input sr-only" type="file"
                                            name="photos" accept="image/*" />
                                        <div
                                            class="photo-empty absolute inset-0 flex flex-col items-center justify-center text-xs text-white/60 gap-1">
                                            <span class="text-base">＋</span><span class="lang-en">Add</span><span
                                                class="lang-si">එක්කරන්න</span>
                                        </div>
                                        <img class="photo-img hidden w-full h-full object-cover"
                                            alt="Photo {{ forloop.counter }} preview" />
                                        <button type="button"
                                            class="photo-remove hidden absolute top-1 right-1 text-[10px] px-2 py-0.5 rounded-full bg-black/60 border border-white/20"><span
                                                class="lang-en">Remove</span><span class="lang-si">ඉවත්
                                                කරන්න</span></button>
                                    </label>
                                    {% endfor %}
                                </div>
                                <p class="mt-2 text-xs text-white/60"><span class="lang-en">Tap a slot to add a photo.
                                        Use “Remove” to clear a slot.</span><span class="lang-si">ඡායාරූප එකතු කිරීමට
                                        පේළියක් තක්කඩන්න. ඉවත් කිරීමට “Remove” භාවිතා කරන්න.</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-5 flex justify-between gap-3">
                        <button type="button"
                            class="btn-prev px-5 py-2.5 rounded-xl bg-white/10 hover:bg-white/15 font-semibold"><span
                                class="lang-en">Back</span><span class="lang-si">ආපසු</span></button>
                        <button type="button"
                            class="btn-next shine px-5 py-2.5 rounded-xl bg-gradient-to-r from-brand-500 to-gold-400 text-white font-bold"><span
                                class="lang-en">Next</span><span class="lang-si">ඊළඟට</span></button>
                    </div>
                </section>

                <!-- STEP 4: Review -->
                <section class="step-panel glass rounded-2xl sm:rounded-3xl p-5 sm:p-6 hidden">
                    <h2 class="text-xl font-bold mb-4"><span class="lang-en">Review & Submit</span><span
                            class="lang-si">සමාලෝචනය කර යවන්න</span></h2>
                    <div class="grid sm:grid-cols-3 gap-4 mb-5">
                        <div class="sm:col-span-1">
                            <label for="visitDate" class="block text-sm font-medium mb-2"><span
                                    class="lang-en">Preferred date</span><span class="lang-si">අභිප්‍රේත
                                    දිනය</span></label>
                            <input id="visitDate" name="visit_date" type="date"
                                class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:border-brand-400"
                                required />
                            <p class="mt-2 text-xs text-white/60"><span class="lang-en">We’ll schedule a call on this
                                    date.</span><span class="lang-si">මෙම දිනයට අපි ඇමතුමක් සැලසුම් කරමු.</span></p>
                        </div>
                        <div class="sm:col-span-2">
                            <label class="block text-sm font-medium mb-2"><span class="lang-en">Time slot</span><span
                                    class="lang-si">වේලා පරාසය</span></label>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3" role="radiogroup"
                                aria-label="Select a time slot">
                                <label
                                    class="slot-label group relative flex items-center justify-between gap-3 h-12 px-4 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:bg-white/10">
                                    <input type="radio" class="sr-only" name="slot" value="09:00-10:00" required />
                                    <div class="flex items-baseline gap-1.5"><span
                                            class="slot-time text-sm font-semibold">9:00–10:00</span><span
                                            class="slot-ampm">AM</span></div>
                                    <span class="checkmark" aria-hidden="true"><svg viewBox="0 0 20 20"
                                            class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="3">
                                            <path d="M4 10l4 4 8-8" />
                                        </svg></span>
                                </label>
                                <label
                                    class="slot-label group relative flex items-center justify-between gap-3 h-12 px-4 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:bg-white/10">
                                    <input type="radio" class="sr-only" name="slot" value="21:00-22:00" required />
                                    <div class="flex items-baseline gap-1.5"><span
                                            class="slot-time text-sm font-semibold">9:00–10:00</span><span
                                            class="slot-ampm">PM</span></div>
                                    <span class="checkmark" aria-hidden="true"><svg viewBox="0 0 20 20"
                                            class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="3">
                                            <path d="M4 10l4 4 8-8" />
                                        </svg></span>
                                </label>
                                <label
                                    class="slot-label group relative flex items-center justify-between gap-3 h-12 px-4 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:bg-white/10">
                                    <input type="radio" class="sr-only" name="slot" value="22:00-23:00" required />
                                    <div class="flex items-baseline gap-1.5"><span
                                            class="slot-time text-sm font-semibold">10:00–11:00</span><span
                                            class="slot-ampm">PM</span></div>
                                    <span class="checkmark" aria-hidden="true"><svg viewBox="0 0 20 20"
                                            class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="3">
                                            <path d="M4 10l4 4 8-8" />
                                        </svg></span>
                                </label>
                            </div>
                            <p class="mt-2 text-xs text-white/60"><span class="lang-en">Unavailable slots for the chosen
                                    date will be disabled automatically.</span><span class="lang-si">තෝරාගත් දිනය සඳහා
                                    නොමැති වේලා පරාස අක්‍රීය වේ.</span></p>
                        </div>
                    </div>

                    <!-- Review summary -->
                    <div class="space-y-4">
                        <div class="grid sm:grid-cols-2 gap-4">
                            <div class="p-4 rounded-xl bg-white/5 border border-white/10">
                                <div class="text-xs text-white/60"><span class="lang-en">Source</span><span
                                        class="lang-si">මූලාශ්‍රය</span></div>
                                <div id="revSource" class="font-semibold mt-1">—</div>
                            </div>
                            <div class="p-4 rounded-xl bg-white/5 border border-white/10">
                                <div class="text-xs text-white/60"><span class="lang-en">Order</span><span
                                        class="lang-si">ඇණවුම</span></div>
                                <div id="revOrder" class="font-semibold mt-1">—</div>
                            </div>
                        </div>
                        <div class="p-4 rounded-xl bg-white/5 border border-white/10">
                            <div class="text-xs text-white/60"><span class="lang-en">Subject</span><span
                                    class="lang-si">මාතෘකාව</span></div>
                            <div id="revSubject" class="font-semibold mt-1">—</div>
                        </div>
                        <div class="p-4 rounded-xl bg-white/5 border border-white/10">
                            <div class="text-xs text-white/60"><span class="lang-en">Description</span><span
                                    class="lang-si">විස්තරය</span></div>
                            <div id="revDescription" class="mt-1 whitespace-pre-line">—</div>
                        </div>
                        <div class="p-4 rounded-xl bg-white/5 border border-white/10">
                            <div class="text-xs text-white/60"><span class="lang-en">Preferred Time</span><span
                                    class="lang-si">අභිප්‍රේත වේලාව</span></div>
                            <div id="revSlot" class="font-semibold mt-1">—</div>
                        </div>
                        <div class="grid sm:grid-cols-2 gap-4">
                            <div class="p-4 rounded-xl bg-white/5 border border-white/10">
                                <div class="text-xs text-white/60 mb-2"><span class="lang-en">Video</span><span
                                        class="lang-si">වීඩියෝ</span></div>
                                <video id="revVideo" class="rounded-lg w-full hidden" controls></video>
                                <div id="revVideoNone" class="text-white/50 text-sm"><span class="lang-en">No video
                                        attached</span><span class="lang-si">වීඩියෝ එකක් නොමැත</span></div>
                            </div>
                            <div class="p-4 rounded-xl bg-white/5 border border-white/10">
                                <div class="text-xs text-white/60 mb-2"><span class="lang-en">Photos</span><span
                                        class="lang-si">ඡායාරූප</span></div>
                                <div id="revPhotos" class="grid grid-cols-5 gap-2"></div>
                                <div id="revPhotosNone" class="text-white/50 text-sm"><span class="lang-en">No photos
                                        attached</span><span class="lang-si">ඡායාරූප නොමැත</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-between gap-3">
                        <button type="button"
                            class="btn-prev px-5 py-2.5 rounded-xl bg-white/10 hover:bg-white/15 font-semibold"><span
                                class="lang-en">Back</span><span class="lang-si">ආපසු</span></button>
                        <button type="submit"
                            class="shine px-6 py-3 rounded-xl bg-gradient-to-r from-brand-500 to-gold-400 text-white font-bold"><span
                                class="lang-en">Submit Ticket</span><span class="lang-si">ටිකට් යවන්න</span></button>
                    </div>
                </section>
            </form>
        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-white/10">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-10 text-center text-sm text-white/60">© <span
                id="year"></span> Virtual Lab Games.</div>
    </footer>

    <script>
        // ---------- Year ----------
        document.getElementById('year').textContent = new Date().getFullYear();

        // ---------- Mobile menu toggle ----------
        const navToggle = document.getElementById('navToggle');
        const mobileMenu = document.getElementById('mobileMenu');
        navToggle?.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));

        // ---------- i18n ----------
        const L = {
            en: {
                toast_ok: 'Ticket submitted! ',
                err_source: 'Please select a source',
                err_vl_order: 'Please select your Virtual Lab order',
                err_daraz_no: 'Please enter Daraz order number',
                err_daraz_date: 'Please enter Daraz order date',
                err_subject: 'Subject is required',
                err_desc: 'Description is required',
                video_long: 'Video must be 2 minutes or less.',
                src_vl: 'Virtual Lab website',
                src_daraz: 'Daraz',
                unavailable: 'Unavailable'
            },
            si: {
                toast_ok: 'ටිකට් යවා ඇත! ',
                err_source: 'කරුණාකර මූලාශ්‍රයක් තෝරන්න',
                err_vl_order: 'කරුණාකර Virtual Lab ඇණවුම තෝරන්න',
                err_daraz_no: 'Daraz ඇණවුම් අංකය ඇතුල් කරන්න',
                err_daraz_date: 'Daraz ඇණවුම් දිනය ඇතුල් කරන්න',
                err_subject: 'මාතෘකාව අවශ්‍යයි',
                err_desc: 'විස්තරය අවශ්‍යයි',
                video_long: 'වීඩියෝව විනාඩි 2ට අඩු විය යුතුය.',
                src_vl: 'Virtual Lab වෙබ්අඩවිය',
                src_daraz: 'Daraz',
                unavailable: 'ප්‍රයෝජනයට නෙවෙයි'
            }
        };
        const getLang = () => (localStorage.getItem('language') === 'si' ? 'si' : 'en');
        const t = (k) => L[getLang()][k] || k;

        // ---------- Toast helper ----------
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bg = type === 'success' ? 'bg-emerald-500/90' : 'bg-red-500/90';
            toast.className = `fixed bottom-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl ${bg} text-white font-semibold text-sm z-[70] shadow-xl transform transition-all`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 2500);
        }

        // ---------- Wizard logic ----------
        const form = document.getElementById('ticketForm');
        const panels = Array.from(document.querySelectorAll('.step-panel'));
        const bullets = Array.from(document.querySelectorAll('.step-bullet'));
        let step = 0;
        function setStep(n) {
            step = Math.max(0, Math.min(panels.length - 1, n));
            panels.forEach((p, i) => p.classList.toggle('hidden', i !== step));
            bullets.forEach((b, i) => {
                const circle = b.querySelector('span');
                if (i <= step) { circle.classList.add('bg-brand-500', 'text-black'); circle.classList.remove('bg-white/10'); }
                else { circle.classList.remove('bg-brand-500', 'text-black'); circle.classList.add('bg-white/10'); }
            });
            window.scrollTo({ top: 0, behavior: 'smooth' });
            if (step === 3) buildReview();
        }
        function next() { if (validateStep(step)) setStep(step + 1); }
        function prev() { setStep(step - 1); }
        document.querySelectorAll('.btn-next').forEach(btn => btn.addEventListener('click', next));
        document.querySelectorAll('.btn-prev').forEach(btn => btn.addEventListener('click', prev));

        // Step 1: source
        const sourceRadios = document.querySelectorAll('input[name="source"]');

        // Step 2 blocks
        const vlBlock = document.getElementById('vlOrderBlock');
        const darazBlock = document.getElementById('darazBlock');
        const orderSelect = document.getElementById('orderSelect');
        const darazNumber = form.querySelector('[name="daraz_order_number"]');
        const darazDate = form.querySelector('[name="daraz_order_date"]');

        sourceRadios.forEach(r => r.addEventListener('change', () => {
            if (r.checked && r.value === 'VIRTUAL_LAB') {
                vlBlock.classList.remove('hidden');
                darazBlock.classList.add('hidden');
                orderSelect?.setAttribute('required', 'required');
                darazNumber?.removeAttribute('required');
                darazDate?.removeAttribute('required');
            }
            if (r.checked && r.value === 'DARAZ') {
                darazBlock.classList.remove('hidden');
                vlBlock.classList.add('hidden');
                orderSelect?.removeAttribute('required');
                darazNumber?.setAttribute('required', 'required');
                darazDate?.setAttribute('required', 'required');
            }
        }));
        function getSource() { const s = Array.from(sourceRadios).find(r => r.checked); return s ? s.value : ''; }

        // Step 3: uploads & validation
        const videoInput = document.getElementById('videoInput');
        const videoPreview = document.getElementById('videoPreview');

        // Step 4: scheduling
        const visitDate = document.getElementById('visitDate');
        const slotRadios = document.querySelectorAll('input[name="slot"]');
        const photoInputs = Array.from(document.querySelectorAll('.photo-input'));

        function wirePhotoSlot(slotEl) {
            const input = slotEl.querySelector('.photo-input');
            const empty = slotEl.querySelector('.photo-empty');
            const img = slotEl.querySelector('.photo-img');
            const remove = slotEl.querySelector('.photo-remove');
            function clearSlot() { input.value = ''; img.removeAttribute('src'); img.classList.add('hidden'); remove.classList.add('hidden'); empty.classList.remove('hidden'); }
            input.addEventListener('change', () => { const file = input.files && input.files[0]; if (!file) { clearSlot(); return; } const url = URL.createObjectURL(file); img.src = url; img.classList.remove('hidden'); empty.classList.add('hidden'); remove.classList.remove('hidden'); });
            remove.addEventListener('click', (e) => { e.preventDefault(); clearSlot(); });
        }
        document.querySelectorAll('.photo-slot').forEach(wirePhotoSlot);
        function resetPhotoSlots() { document.querySelectorAll('.photo-slot').forEach(slot => { const remove = slot.querySelector('.photo-remove'); if (!remove.classList.contains('hidden')) remove.click(); }); }

        videoInput?.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) { videoPreview.classList.add('hidden'); videoPreview.removeAttribute('src'); return; }
            const ok = await checkVideoDuration(file, 120);
            if (!ok) { showToast(t('video_long'), 'error'); e.target.value = ''; videoPreview.classList.add('hidden'); videoPreview.removeAttribute('src'); return; }
            const url = URL.createObjectURL(file); videoPreview.src = url; videoPreview.classList.remove('hidden');
        });
        function checkVideoDuration(file, maxSeconds) { return new Promise((resolve) => { const v = document.createElement('video'); v.preload = 'metadata'; v.onloadedmetadata = () => { URL.revokeObjectURL(v.src); resolve((v.duration || 0) <= maxSeconds); }; v.onerror = () => resolve(false); v.src = URL.createObjectURL(file); }); }

        function validateStep(s) {
            if (s === 0) { if (!getSource()) { showToast(t('err_source'), 'error'); return false; } }
            if (s === 1) {
                const src = getSource();
                if (src === 'VIRTUAL_LAB' && (!orderSelect || !orderSelect.value)) { showToast(t('err_vl_order'), 'error'); return false; }
                if (src === 'DARAZ') { if (!darazNumber.value) { showToast(t('err_daraz_no'), 'error'); return false; } if (!darazDate.value) { showToast(t('err_daraz_date'), 'error'); return false; } }
            }
            if (s === 2) {
                const subject = document.getElementById('subject'); const description = document.getElementById('description');
                if (!subject.value.trim()) { showToast(t('err_subject'), 'error'); return false; }
                if (!description.value.trim()) { showToast(t('err_desc'), 'error'); return false; }
            }
            return true;
        }

        function slotHuman(v) { if (v === '09:00-10:00') return '9:00–10:00 AM'; if (v === '21:00-22:00') return '9:00–10:00 PM'; if (v === '22:00-23:00') return '10:00–11:00 PM'; return v || ''; }
        function getSelectedSlotValue() { const r = Array.from(slotRadios).find(r => r.checked); return r ? r.value : ''; }

        function buildReview() {
            const src = getSource();
            document.getElementById('revSource').textContent = src === 'VIRTUAL_LAB' ? t('src_vl') : t('src_daraz');
            if (src === 'VIRTUAL_LAB') { const txt = orderSelect?.selectedOptions[0]?.text || '—'; document.getElementById('revOrder').textContent = txt; }
            else {
                const parts = []; if (darazNumber.value) parts.push('#' + darazNumber.value); if (darazDate.value) parts.push(new Date(darazDate.value).toISOString().slice(0, 10)); document.getElementById('revOrder').textContent = parts.join(' • ') || '—';
            }
            document.getElementById('revSubject').textContent = document.getElementById('subject').value || '—';
            document.getElementById('revDescription').textContent = document.getElementById('description').value || '—';
            const selectedSlot = getSelectedSlotValue();
            const dateText = (visitDate && visitDate.value) ? new Date(visitDate.value).toISOString().slice(0, 10) : '';
            const human = slotHuman(selectedSlot);
            const revSlot = document.getElementById('revSlot'); revSlot.textContent = (dateText && human) ? `${dateText} • ${human}` : '—';
            const revVideo = document.getElementById('revVideo'); const revVideoNone = document.getElementById('revVideoNone');
            if (videoInput.files && videoInput.files[0]) { revVideo.src = URL.createObjectURL(videoInput.files[0]); revVideo.classList.remove('hidden'); revVideoNone.classList.add('hidden'); }
            else { revVideo.removeAttribute('src'); revVideo.classList.add('hidden'); revVideoNone.classList.remove('hidden'); }
            const revPhotos = document.getElementById('revPhotos'); const revPhotosNone = document.getElementById('revPhotosNone'); revPhotos.innerHTML = '';
            const photoFiles = photoInputs.map(inp => inp.files[0]).filter(Boolean);
            if (photoFiles.length) { photoFiles.forEach(f => { const url = URL.createObjectURL(f); const img = document.createElement('img'); img.src = url; img.alt = f.name; img.className = 'w-full h-16 object-cover rounded-lg'; const wrap = document.createElement('div'); wrap.className = 'rounded-lg overflow-hidden border border-white/10'; wrap.appendChild(img); revPhotos.appendChild(wrap); }); revPhotosNone.classList.add('hidden'); }
            else { revPhotosNone.classList.remove('hidden'); }
        }

        // Initialize defaults
        if (visitDate && !visitDate.value) {
            const tnow = new Date(); const yyyy = tnow.getFullYear(); const mm = String(tnow.getMonth() + 1).padStart(2, '0'); const dd = String(tnow.getDate()).padStart(2, '0'); visitDate.value = `${yyyy}-${mm}-${dd}`;
        }

        // Slots availability
        const slotsApiUrl = "{% url 'api-reserved-slots' %}";
        function applyUnavailable(dateStr, unavailable) {
            document.querySelectorAll('input[name="slot"]').forEach((radio) => {
                const label = radio.closest('label.slot-label');
                label.querySelector('.unavailable-badge')?.remove();
                label.classList.remove('unavailable', 'disabled');
                label.removeAttribute('aria-disabled');
                radio.disabled = false;
                const isUnavailable = (unavailable || []).includes(radio.value);
                if (isUnavailable) {
                    if (radio.checked) radio.checked = false;
                    radio.disabled = true; label.classList.add('unavailable', 'disabled'); label.setAttribute('aria-disabled', 'true');
                    const badge = document.createElement('span'); badge.className = 'unavailable-badge'; badge.textContent = t('unavailable'); label.appendChild(badge);
                }
            });
            if (step === 3) buildReview();
        }
        async function refreshSlots(dateStr) {
            try {
                const res = await fetch(`${slotsApiUrl}?date=${encodeURIComponent(dateStr)}`, { headers: { 'Accept': 'application/json' } });
                if (!res.ok) throw new Error('Failed to load slots');
                const data = await res.json();
                applyUnavailable(data.date, data.unavailable || []);
            } catch (e) { console.error(e); showToast('Could not load time slots. Please try again.', 'error'); }
        }
        if (visitDate) { const today = new Date(); const yyyy = today.getFullYear(); const mm = String(today.getMonth() + 1).padStart(2, '0'); const dd = String(today.getDate()).padStart(2, '0'); visitDate.min = `${yyyy}-${mm}-${dd}`; refreshSlots(visitDate.value); }
        visitDate?.addEventListener('change', () => { refreshSlots(visitDate.value); if (step === 3) buildReview(); });
        document.querySelectorAll('input[name="slot"]').forEach(r => r.addEventListener('change', () => { if (step === 3) buildReview(); }));

        // Fallback selected-state sync
        function syncCheckedStyles() {
            document.querySelectorAll('label.option').forEach(l => { const isChecked = !!l.querySelector('input[type="radio"]:checked'); l.classList.toggle('selected', isChecked); });
            document.querySelectorAll('label.slot-label').forEach(l => { const isChecked = !!l.querySelector('input[type="radio"]:checked'); l.classList.toggle('selected', isChecked); });
        }
        document.addEventListener('change', (e) => { if (e.target.matches('input[name="source"], input[name="slot"]')) { syncCheckedStyles(); } });
        syncCheckedStyles();
        setStep(0);

        // CSRF helper
        function getCookie(name) { const value = `; ${document.cookie}`; const parts = value.split(`; ${name}=`); if (parts.length === 2) return parts.pop().split(';').shift(); }

        // Submit
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(form);
            try {
                const res = await fetch("{% url 'api-ticket-create' %}", { method: "POST", headers: { "X-CSRFToken": getCookie('csrftoken') }, body: fd });
                const json = await res.json();
                if (!res.ok || json.ok === false) { throw new Error(json.error || "Could not submit ticket"); }
                showToast(`${t('toast_ok')}#${json.ticket.reference}`);
                form.reset(); resetPhotoSlots();
                videoPreview?.removeAttribute('src'); videoPreview?.classList.add('hidden');
                setStep(0);
            } catch (err) { console.error(err); showToast(err.message, 'error'); }
        });

        // ---------- Language toggle (same behavior as other pages) ----------
        document.addEventListener('DOMContentLoaded', function () {
            const langToggleBtn = document.getElementById('langToggleBtn');
            const langToggleBtnMobile = document.getElementById('langToggleBtnMobile');
            const body = document.body;

            const enTitle = 'Open Support Ticket — Virtual Lab Games';
            const siTitle = 'සහාය ටිකට් එකක් අරඹන්න — Virtual Lab Games';
            const enDesc = "Open a support ticket with Virtual Lab Games. Tell us the issue and preferred time — we'll help you get playing again fast.";
            const siDesc = 'Virtual Lab Games සමඟ සහාය ටිකට් එකක් අරඹන්න. ගැටලුව හා කැමති වේලාව දන්වා — ඉක්මනින් විසඳන්නම්.';
            const metaDescription = document.querySelector('meta[name="description"]');

            const setLanguage = (lang) => {
                if (lang === 'si') {
                    body.classList.add('sinhala-mode');
                    body.classList.add('font-sinhala');
                    langToggleBtn && (langToggleBtn.textContent = 'EN');
                    langToggleBtnMobile && (langToggleBtnMobile.textContent = 'EN');
                    document.title = siTitle;
                    metaDescription?.setAttribute('content', siDesc);
                    localStorage.setItem('language', 'si');
                } else {
                    body.classList.remove('sinhala-mode');
                    body.classList.remove('font-sinhala');
                    langToggleBtn && (langToggleBtn.textContent = 'සිංහල');
                    langToggleBtnMobile && (langToggleBtnMobile.textContent = 'සිංහල');
                    document.title = enTitle;
                    metaDescription?.setAttribute('content', enDesc);
                    localStorage.setItem('language', 'en');
                }
                // refresh any dynamic review text
                if (step === 3) buildReview();
            };
            const toggleLanguage = () => { const currentLang = localStorage.getItem('language') || 'en'; setLanguage(currentLang === 'en' ? 'si' : 'en'); };
            langToggleBtn?.addEventListener('click', toggleLanguage);
            langToggleBtnMobile?.addEventListener('click', toggleLanguage);
            const savedLang = localStorage.getItem('language');
            setLanguage(savedLang || 'en');
        });
    </script>
</body>

</html>
{% load static %}
<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Select a Storage Device â€” Virtual Lab Games</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { brand: { 50: '#F1F7FF', 100: '#DDEBFF', 200: '#B8D5FF', 300: '#90BDFF', 400: '#5EA1FF', 500: '#2D86FF', 600: '#1E6CE0', 700: '#164FB3', 800: '#0E377F', 900: '#0A2559' } },
                    animation: { 'float': 'float 6s ease-in-out infinite', 'pulse-slow': 'pulse 3s cubic-bezier(0.4,0,0.6,1) infinite' },
                    keyframes: { float: { '0%,100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-12px)' } } }
                }
            }
        }
    </script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --noise-opacity: .04;
        }

        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            overflow-x: hidden;
        }

        .bg-aurora {
            background: radial-gradient(ellipse 1400px 800px at 10% -20%, rgba(79, 70, 229, .4), transparent 45%),
                radial-gradient(ellipse 1000px 600px at 90% 10%, rgba(16, 185, 129, .3), transparent 50%),
                radial-gradient(ellipse 1200px 800px at 50% 120%, rgba(6, 182, 212, .35), transparent 55%),
                linear-gradient(180deg, #0a0b14 0%, #05060b 100%);
            background-attachment: fixed;
        }

        .noise::before {
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            opacity: var(--noise-opacity);
            mix-blend-mode: soft-light;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter><rect width="100" height="100" filter="url(%23n)" opacity="0.15"/></svg>');
        }

        .glass {
            background: linear-gradient(135deg, rgba(255, 255, 255, .10), rgba(255, 255, 255, .04));
            backdrop-filter: saturate(150%) blur(16px);
            -webkit-backdrop-filter: saturate(150%) blur(16px);
            border: 1px solid rgba(255, 255, 255, .12);
            box-shadow: 0 8px 32px rgba(0, 0, 0, .2);
        }

        .glass-dark {
            background: linear-gradient(135deg, rgba(0, 0, 0, .4), rgba(0, 0, 0, .2));
            backdrop-filter: saturate(150%) blur(20px);
            -webkit-backdrop-filter: saturate(150%) blur(20px);
            border: 1px solid rgba(255, 255, 255, .08);
        }

        .shine {
            position: relative;
            overflow: hidden;
        }

        .shine::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -60%;
            width: 30%;
            height: 200%;
            transform: rotate(25deg);
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .4), transparent);
            animation: shine 4s infinite;
        }

        @keyframes shine {
            0% {
                left: -60%
            }

            100% {
                left: 140%
            }
        }
    </style>
</head>

<body class="bg-aurora text-white selection:bg-brand-500/30 selection:text-white noise">
    <!-- Header -->
    <header class="sticky top-0 z-50 glass-dark border-b border-white/10">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="/" class="flex items-center gap-2 sm:gap-3 group">
                    <span
                        class="relative inline-flex items-center justify-center w-10 h-10 rounded-xl bg-gradient-to-tr from-brand-500 to-cyan-400 shadow-lg shadow-brand-500/25 group-hover:shadow-brand-500/40 transition-shadow"><span
                            class="text-xl">ðŸŽ®</span></span>
                    <div class="flex flex-col"><span class="font-black text-lg sm:text-xl tracking-tight">Virtual
                            Lab</span><span class="text-[10px] sm:text-xs text-white/60 font-medium -mt-1">GAMES</span>
                    </div>
                </a>
                <div class="flex items-center gap-2 sm:gap-3">
                    <a href="/shop"
                        class="shine inline-flex items-center gap-2 px-3 sm:px-4 py-2 rounded-xl bg-gradient-to-r from-brand-500 to-cyan-400 text-black text-sm font-bold shadow-lg hover:shadow-xl transition-all">Back
                        to shop</a>
                </div>
            </div>
        </div>
    </header>

    <main class="py-10 sm:py-14 lg:py-16">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-6xl">
            <div class="mb-6 sm:mb-8">
                <div
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-full glass text-xs sm:text-sm font-semibold">
                    <span class="relative flex h-2 w-2"><span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span
                            class="relative inline-flex rounded-full h-2 w-2 bg-emerald-400"></span></span>
                    <span>Pick a device â€¢ Games included free</span>
                </div>
                <h1 class="mt-3 text-3xl sm:text-4xl lg:text-5xl font-black">Choose your storage device</h1>
                <p class="mt-1 text-white/70">Weâ€™ll preload your selected titles â€” you only pay for the hardware.</p>
            </div>

            <!-- Filter (category only) -->
            <div class="glass rounded-2xl sm:rounded-3xl p-4 sm:p-6 mb-4">
                <div class="flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
                    <div class="flex-1 grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <div>
                            <select id="category"
                                class="w-full px-4 py-3 rounded-xl bg-white/10 ring-1 ring-white/10 focus:ring-2 focus:ring-brand-500 outline-none">
                                <option value="">All categories</option>
                                <option value="hard_disk">Hard disk</option>
                                <option value="portable_hard_disk">Portable hard disk</option>
                                <option value="pen">Pen drive</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 text-sm text-white/70">
                            <span id="count">0 devices</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <a href="/shop"
                            class="px-4 py-3 rounded-xl bg-white/10 hover:bg-white/15 font-semibold">Continue
                            shopping</a>
                    </div>
                </div>
            </div>

            <!-- Device grid -->
            <div id="grid" class="grid gap-4 sm:gap-5 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3"></div>
            <div id="empty" class="hidden text-center text-white/70 py-16">No devices found. Try a different category.
            </div>
        </div>
    </main>

    <!-- Toast -->
    <div id="toast"
        class="fixed left-1/2 -translate-x-1/2 bottom-5 z-50 px-4 py-3 rounded-xl bg-black/80 text-white shadow-lg hidden">
        Saved! Device selected.</div>

    <!-- Footer -->
    <footer class="border-t border-white/10">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-10 text-center text-sm text-white/60">Â© <span
                id="year"></span> Virtual Lab Games.</div>
    </footer>

    <script>
        // -------- Config & helpers --------
        const API_LIST = "{% url 'api-storage-devices' %}"; // JSON list
        const API_SELECT = "{% url 'api_cart_select_storage' %}"; // POST select
        const SHOP_URL = "/shop"; // redirect here after selecting

        function getCookie(name) { const value = `; ${document.cookie}`.split(`; ${name}=`); if (value.length === 2) return value.pop().split(';').shift(); }
        const csrftoken = getCookie('csrftoken');

        const grid = document.getElementById('grid');
        const emptyState = document.getElementById('empty');
        const countEl = document.getElementById('count');
        const toast = document.getElementById('toast');

        const showToast = (msg) => { toast.textContent = msg; toast.classList.remove('hidden'); setTimeout(() => toast.classList.add('hidden'), 1400); };
        const fmt = (x) => (x == null ? '0.00' : String(x));
        const fmtGB = (x) => { const n = Number(x || 0); return (Number.isFinite(n) ? n.toFixed(0) : x) + ' GB'; };

        // -------- API calls --------
        async function fetchDevices() { const r = await fetch(API_LIST, { credentials: 'same-origin' }); if (!r.ok) throw new Error('Failed to load devices'); const d = await r.json(); return d.results || []; }
        async function selectDevice(id) { const r = await fetch(API_SELECT, { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken }, body: JSON.stringify({ device_id: id }) }); if (!r.ok) { const e = await r.json().catch(() => ({ detail: 'Failed to set device' })); throw new Error(e.detail || 'Failed to set device'); } return r.json(); }

        // -------- Renderers --------
        function cardHtml(d) {
            const img = d.image_url || "{% static 'images/drive-placeholder-16x9.jpg' %}";
            const currency = d.currency || '';
            const price = d.price != null ? `${currency} ${fmt(d.price)}` : '';
            return `
        <article class="group relative overflow-hidden rounded-2xl glass ring-1 ring-white/10 hover:ring-white/20 transition-all">
          <div class="aspect-video w-full overflow-hidden bg-white/5"><img src="${img}" alt="${d.name}" class="h-full w-full object-cover" /></div>
          <div class="p-4">
            <div class="flex items-start justify-between gap-3">
              <div>
                <h3 class="font-bold leading-tight">${d.name}</h3>
                <div class="mt-0.5 text-xs text-white/60">${d.category_label || d.category || ''}</div>
              </div>
              ${price ? `<div class=\"shrink-0 px-2 py-1 rounded-lg bg-white/10 text-xs font-semibold\">${price}</div>` : ''}
            </div>
            <div class="mt-3 grid grid-cols-2 gap-2 text-xs text-white/70">
              <div class="rounded-lg bg-white/5 px-2 py-1">Capacity <span class="font-semibold text-white/90">${fmtGB(d.true_capacity_gb)}</span></div>
              <div class="rounded-lg bg-white/5 px-2 py-1">Label <span class="font-semibold text-white/90">${fmtGB(d.marketing_capacity_gb)}</span></div>
            </div>
            <div class="mt-4 grid grid-cols-1">
              <button class="select-btn px-4 py-3 rounded-xl bg-white/10 hover:bg-white/15 font-semibold" data-id="${d.id}">Use this device</button>
            </div>
          </div>
        </article>`;
        }

        function render(list) {
            countEl.textContent = `${list.length} device${list.length === 1 ? '' : 's'}`;
            if (!list.length) { grid.innerHTML = ''; emptyState.classList.remove('hidden'); return; }
            emptyState.classList.add('hidden');
            grid.innerHTML = list.map(cardHtml).join('');
        }

        // -------- Init / filters --------
        let ALL = [];
        function applyFilters() {
            const c = document.getElementById('category').value;
            const filtered = ALL.filter(d => !c || d.category === c);
            render(filtered);
        }

        async function boot() {
            document.getElementById('year').textContent = new Date().getFullYear();
            ALL = await fetchDevices();
            applyFilters();

            document.getElementById('category').addEventListener('change', applyFilters);

            grid.addEventListener('click', async (e) => {
                const btn = e.target.closest('.select-btn');
                if (!btn) return;
                const id = btn.getAttribute('data-id');
                btn.disabled = true; const old = btn.textContent; btn.textContent = 'Selectingâ€¦';
                try {
                    await selectDevice(id);
                    showToast('Device selected. Heading to the shopâ€¦');
                    setTimeout(() => window.location.href = SHOP_URL, 600);
                } catch (err) {
                    alert(err.message || 'Failed to set device');
                    btn.disabled = false; btn.textContent = old;
                }
            });
        }

        boot().catch(err => {
            console.error(err);
            emptyState.classList.remove('hidden');
            emptyState.textContent = 'Failed to load devices.';
        });
    </script>
</body>

</html>
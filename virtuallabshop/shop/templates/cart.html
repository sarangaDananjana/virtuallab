<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    {% load static %}
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Your Cart — Virtual Lab Games</title>
    <meta name="description"
        content="Review your selections, storage device, and checkout with fast islandwide delivery and install support." />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#F1F7FF', 100: '#DDEBFF', 200: '#B8D5FF', 300: '#90BDFF', 400: '#5EA1FF', 500: '#2D86FF', 600: '#1E6CE0', 700: '#164FB3', 800: '#0E377F', 900: '#0A2559' },
                        gold: { 50: '#FFFBEB', 100: '#FEF3C7', 200: '#FDE68A', 300: '#FCD34D', 400: '#f6cd45', 500: '#F59E0B', 600: '#D97706', 700: '#B45309', 800: '#92400E', 900: '#78350F' }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4,0,0.6,1) infinite',
                        'gradient': 'gradient 8s ease infinite',
                        'slide-up': 'slideUp 0.3s ease-out',
                    },
                    keyframes: {
                        float: { '0%,100%': { transform: 'translateY(0px)' }, '50%': { transform: 'translateY(-20px)' } },
                        gradient: { '0%,100%': { 'background-position': '0% 50%' }, '50%': { 'background-position': '100% 50%' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600;700&family=Maname&display=swap"
        rel="stylesheet">

    <!-- Shared site styles for aurora bg, glass, header blend, noise, Sinhala helpers -->
    <link rel="stylesheet" href="{% static 'css/home.css' %}">

    <style>
        /* Language helpers (match other pages) */
        .lang-si {
            display: none;
        }

        body.sinhala-mode .lang-en {
            display: none;
        }

        body.sinhala-mode .lang-si {
            display: inline;
        }

        .block-lang.lang-si {
            display: none;
        }

        body.sinhala-mode .block-lang.lang-en {
            display: none;
        }

        body.sinhala-mode .block-lang.lang-si {
            display: block;
        }
    </style>
</head>

<body class="bg-aurora text-white selection:bg-gold-400/30 selection:text-white noise">
    <!-- =================================================================
    HEADER - UPDATED WITH NEW MOBILE MENU
    ================================================================== -->
    <header class="header-blend sticky top-0 z-[80]">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16 sm:h-18">
                <!-- Logo -->
                <a href="{% url 'home-page' %}" class="flex items-center gap-2 sm:gap-3">
                    <img src="{% static 'images/Virtuallab.png' %}" alt="Virtual Lab logo"
                        class="h-10 sm:h-12 w-auto object-contain" width="48" height="48" decoding="async" />
                    <div class="flex flex-col">
                        <span class="font-black text-base sm:text-lg lg:text-xl tracking-tight">Virtual Lab</span>
                        <span class="text-[10px] sm:text-xs font-medium -mt-0.5">GAMES</span>
                    </div>
                </a>

                <!-- Desktop Navigation (links point to Home sections) -->
                <nav class="hidden lg:flex items-center gap-6 xl:gap-8">
                    <a href="{% url 'home-page' %}"
                        class="text-sm font-semibold transition-colors hover:text-gold-400"><span
                            class="lang-en">Home</span><span class="lang-si">Home</span></a>
                    <a href="{% url 'blog_page' %}" class="text-sm font-semibold transition-colors text-gold-400">
                        <span class="lang-en">Blog</span><span class="lang-si">බ්ලොග්</span></a>
                    <a href="{% url 'tickets-page' %}"
                        class="text-sm font-semibold transition-colors hover:text-gold-400"><span
                            class="lang-en">Support</span><span class="lang-si">සහය</span></a>
                </nav>

                <!-- Action Buttons -->
                <div class="flex items-center gap-2 sm:gap-3">
                    <button id="langToggleBtn"
                        class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-white/10 hover:bg-white/15 text-sm font-bold transition-all">EN</button>

                    <a href="{% url 'cart_page' %}"
                        class="shine inline-flex items-center gap-1.5 sm:gap-2 px-3 sm:px-4 py-2 sm:py-2.5 rounded-xl bg-white/10 hover:bg-white/20 text-white text-xs sm:text-sm font-bold transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2 9m13-9l2 9M10 21a1 1 0 100-2 1 1 0 000 2zm8 0a1 1 0 100-2 1 1 0 000 2z" />
                        </svg>
                        <span class="hidden sm:inline"><span class="lang-en">Cart</span><span
                                class="lang-si">Cart</span></span>
                    </a>

                    <a href="{% url 'shop-page' %}"
                        class="store-pop shine inline-flex items-center gap-1.5 sm:gap-2 px-3 sm:px-5 py-2 sm:py-2.5 rounded-xl bg-gradient-to-r from-brand-500 to-gold-400 text-white text-xs sm:text-sm font-bold shadow-lg hover:shadow-xl transition-all"
                        aria-label="Shop">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                        </svg>
                        <span class="hidden sm:inline">
                            <span class="lang-en">Shop</span><span class="lang-si">වෙළඳසැල</span>
                        </span>
                    </a>

                    {% if user.is_authenticated %}
                    <a href="{% url 'profile-page' %}" aria-label="Account"
                        class="hidden lg:inline-flex items-center justify-center w-10 h-10 rounded-xl bg-white/10 hover:bg-white/15 font-bold uppercase transition-all">
                        {{user_initial }}</a>
                    {% else %}
                    <a href="{% url 'login-page' %}"
                        class="hidden lg:inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15 text-sm font-semibold transition-all"><span
                            class="lang-en">Login</span><span class="lang-si">ඇතුළු වන්න</span></a>
                    {% endif %}

                    <button id="navToggle"
                        class="lg:hidden p-2 rounded-lg bg-white/10 hover:bg-white/15 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>


    </header>

    <main class="py-10 sm:py-14 lg:py-16">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-6xl">
            <div class="mb-6 sm:mb-8 flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4">
                <div>
                    <div
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-full glass text-xs sm:text-sm font-semibold">
                        <span class="relative flex h-2 w-2"><span
                                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span
                                class="relative inline-flex rounded-full h-2 w-2 bg-emerald-400"></span></span>
                        <span class="lang-en">Cart • Ready to play</span><span class="lang-si">කරත්තය • ක්‍රීඩා කිරීමට
                            සූදානම්</span>
                    </div>
                    <h1 class="mt-3 text-3xl sm:text-4xl lg:text-5xl font-black">
                        <span class="block block-lang lang-en">Review your picks</span>
                        <span class="block block-lang lang-si">ඔබගේ තේරීම් සමාලෝචනය කරන්න</span>
                    </h1>
                    <p class="mt-1 text-white/70"><span class="lang-en">Skip long downloads. Get premium DVDs with
                            step‑by‑step install support.</span><span class="lang-si">දිගු බාගත කරගැනීම් වලින් ඉවත්
                            වන්න. පියවරෙන් පියවර ස්ථාපන සහාය සමඟ උසස් තත්ත්වයේ DVD ලබාගන්න.</span></p>
                </div>
            </div>

            <div class="grid lg:grid-cols-3 gap-4 sm:gap-5">
                <section class="lg:col-span-2 glass rounded-2xl sm:rounded-3xl p-4 sm:p-6">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl sm:text-2xl font-bold"><span class="lang-en">Buy games directly</span><span
                                class="lang-si">ගේම්ස් සෘජුව මිලදී ගන්න</span></h2>
                        <span class="text-xs px-2 py-1 rounded-lg bg-white/10"><span class="lang-en">Pay per
                                game</span><span class="lang-si">ගේම් එකකට ගෙවීම්</span></span>
                    </div>
                    <div id="left-items" class="mt-3 divide-y divide-white/10"></div>
                    <div class="mt-4 flex items-center justify-between font-semibold">
                        <span class="text-white/80"><span class="lang-en">Direct subtotal</span><span
                                class="lang-si">ඒකරාශි (සෘජු)</span></span>
                        <span id="direct-total">—</span>
                    </div>
                </section>

                <aside class="glass rounded-2xl sm:rounded-3xl p-4 sm:p-6">
                    <h2 class="text-xl sm:text-2xl font-bold"><span class="lang-en">Device bundle (games included
                            free)</span><span class="lang-si">උපාංග පැකේජය (ගේම් නොමිලේ)</span></h2>
                    <p class="mt-1 text-sm text-white/70"><span class="lang-en">Pick a storage device and load it up —
                            you pay only for the device.</span><span class="lang-si">ගබඩා උපාංගයක් තෝරා ගේම් එක්කරන්න —
                            ඔබ ගෙවන්නේ උපාංගයට පමණි.</span></p>
                    <div id="device-block" class="mt-4"></div>
                    <div id="capacity-block" class="hidden mt-4">
                        <div class="flex items-center justify-between text-xs text-white/70">
                            <span class="lang-en">Used</span><span class="lang-si">භාවිතා කළ</span> <span>•</span>
                            <span><span id="used-gb">0</span> GB • <span id="used-pct">0</span>%</span>
                        </div>
                        <div class="mt-2 h-2 w-full rounded-full bg-white/10 overflow-hidden">
                            <div id="bar" class="h-full rounded-full bg-gradient-to-r from-brand-500 to-gold-400"
                                style="width:0%"></div>
                        </div>
                        <div class="mt-1 text-xs text-white/70"><span class="lang-en">Remaining</span><span
                                class="lang-si">ඉතිරි</span>: <span id="rem-gb">0</span> GB</div>
                    </div>
                    <div id="right-items" class="mt-4 divide-y divide-white/10"></div>
                    <div class="mt-4 flex items-center justify-between font-semibold">
                        <span class="text-white/80"><span class="lang-en">Device</span><span
                                class="lang-si">උපාංගය</span></span>
                        <span id="device-price">—</span>
                    </div>
                    <div class="mt-4 grid grid-cols-1 gap-2">
                        <a href="{% url 'pick_storage' %}"
                            class="w-full inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-white/10 hover:bg-white/15 font-semibold"><span
                                class="lang-en">Select / change device</span><span class="lang-si">උපාංගය තෝරන්න / වෙනස්
                                කරන්න</span></a>
                        <button id="btnRemoveDevice"
                            class="w-full inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-white/10 hover:bg-white/15 border border-red-500/40 text-red-200 font-semibold"><span
                                class="lang-en">Remove device</span><span class="lang-si">උපාංගය ඉවත්
                                කරන්න</span></button>
                    </div>
                </aside>
            </div>

            <div class="mt-4 glass rounded-2xl sm:rounded-3xl p-4 sm:p-6">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div>
                        <div class="text-sm text-white/70"><span class="lang-en">Grand total</span><span
                                class="lang-si">මුළු එකතුව</span></div>
                        <div id="grand-total" class="text-2xl sm:text-3xl font-black">—</div>
                        <div class="mt-2 flex items-center justify-between text-sm text-white/80">
                            <span class="lang-en">Shipping fee</span><span class="lang-si">බෙදාහැරීම් ගාස්තුව</span>
                            <span id="shipping-fee" class="font-semibold">—</span>
                        </div>
                        <div class="mt-1 text-xs text-white/60"><span class="lang-en">Installation help included • Fast
                                islandwide delivery</span><span class="lang-si">ස්ථාපන සහාය ඇතුළත් • දිවයින පුරා වේගවත්
                                බෙදාහැරීම</span></div>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-3">
                        <a href="{% url 'shop-page' %}"
                            class="px-4 py-3 rounded-xl bg-white/10 hover:bg-white/15 font-semibold"><span
                                class="lang-en">Continue shopping</span><span class="lang-si">දැන්වීම් දිගටම</span></a>
                        <button id="btnCheckout"
                            class="shine px-5 py-3 rounded-xl bg-gradient-to-r from-brand-500 to-gold-400 text-white font-bold shadow-lg hover:shadow-2xl transition-all disabled:opacity-50 disabled:cursor-not-allowed"><span
                                class="lang-en">Checkout</span><span class="lang-si">ගෙවීම් කිරීම</span></button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="border-t border-white/10">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-10 text-center text-sm text-white/60">© <span
                id="year"></span> Virtual Lab Games.</div>
    </footer>

    <div id="mobileMenuContainer" class="fixed inset-0 z-[90] pointer-events-none lg:hidden">
        <div id="mobileMenuOverlay"
            class="absolute inset-0 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-300 ease-in-out">
        </div>
        <div id="mobileMenu"
            class="absolute top-0 right-0 h-full w-full max-w-xs bg-aurora/95 backdrop-blur-xl shadow-2xl flex flex-col noise transform translate-x-full transition-transform duration-300 ease-in-out">
            <div class="flex items-center justify-between p-4 border-b border-white/10">
                <div class="flex items-center gap-2">
                    <img src="{% static 'images/Virtuallab.png' %}" alt="Virtual Lab logo"
                        class="h-8 w-auto object-contain" />
                    <span class="font-bold text-lg">Menu</span>
                </div>
                <button id="closeNav" type="button" class="p-2 rounded-full hover:bg-white/10 transition-colors">
                    <svg class="w-6 h-6 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
                {% if user.is_authenticated %}
                <a href="{% url 'profile-page' %}"
                    class="mobile-menu-link group flex items-center gap-3 w-full text-left px-4 py-3 rounded-lg bg-white/5 hover:bg-white/10 text-white transition-colors focus:outline-none focus:ring-2 focus:ring-gold-400">
                    <div
                        class="flex items-center justify-center w-10 h-10 rounded-full bg-gradient-to-br from-brand-500/80 to-gold-400/80 font-bold uppercase text-white">
                        {{ user_initial }}</div>
                    <div class="text-sm text-white/90"><span class="lang-en">Hello</span><span
                            class="lang-si">ආයුබෝවන්</span>, {{ user.username }}</div>
                </a>
                {% else %}
                <a href="{% url 'login-page' %}"
                    class="mobile-menu-link group flex items-center gap-3 w-full text-left px-4 py-3 rounded-lg hover:bg-white/10 text-white transition-colors font-semibold focus:outline-none focus:ring-2 focus:ring-gold-400">
                    <svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                    </svg>
                    <span><span class="lang-en">Login / Register</span><span class="lang-si">ඇතුළු වන්න</span></span>
                </a>
                {% endif %}

                <hr class="border-white/10 my-4">

                <a href="{% url 'home-page' %}"
                    class="mobile-menu-link group flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 text-white/80 hover:text-white transition-colors font-semibold">
                    <svg class="w-5 h-5 text-white/50 group-hover:text-gold-400" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                        </path>
                    </svg>
                    <span><span class="lang-en">Home</span><span class="lang-si">Home</span></span>
                </a>
                <a href="{% url 'shop-page' %}"
                    class="mobile-menu-link group flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 text-white/80 hover:text-white transition-colors font-semibold">
                    <svg class="w-5 h-5 text-white/50 group-hover:text-gold-400" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                    </svg>
                    <span><span class="lang-en">Shop</span><span class="lang-si">වෙළඳසැල</span></span>
                </a>

                <a href="{% url 'blog_page' %}"
                    class="mobile-menu-link group flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 text-white/80 hover:text-white transition-colors font-semibold">
                    <svg class="w-5 h-5 text-white/50 group-hover:text-gold-400" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
                    </svg>
                    <span><span class="lang-en">Blog</span><span class="lang-si">බ්ලොග්</span></span>
                </a>

                <a href="{% url 'tickets-page' %}"
                    class="mobile-menu-link group flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 text-white/80 hover:text-white transition-colors font-semibold">
                    <svg class="w-5 h-5 text-white/50 group-hover:text-gold-400" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 012-2h3a2 2 0 012 2v14a2 2 0 01-2 2H7a2 2 0 01-2-2V5z">
                        </path>
                    </svg>
                    <span><span class="lang-en">Support</span><span class="lang-si">සහය</span></span>
                </a>
            </nav>

            <div class="p-4 mt-auto border-t border-white/10">
                <button id="langToggleBtnMobile"
                    class="flex items-center justify-center gap-2 w-full px-4 py-3 rounded-lg hover:bg-white/10 text-white transition-colors font-semibold">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 5h12M9 3v2m4 13l4-4M9 17v2M5 11h12M4 17h12a2 2 0 002-2v-4a2 2 0 00-2-2H4a2 2 0 00-2 2v4a2 2 0 002 2z" />
                    </svg>
                    <span class="lang-en">Switch to සිංහල</span>
                    <span class="lang-si">Switch to English</span>
                </button>
            </div>
        </div>
    </div>

    <!-- =================================================================
    CHECKOUT MODAL - UPDATED FOR MULTI-STEP PAYMENT FLOW
    ================================================================== -->
    <div id="checkoutModal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" id="checkoutModalBackdrop"></div>
        <div class="relative flex items-center justify-center min-h-screen p-4">
            <div id="checkoutModalContent" class="glass rounded-3xl max-w-lg w-full mx-auto flex flex-col max-h-[90vh]">

                <!-- STEP 1: Shipping Details -->
                <div id="checkoutStep1">
                    <div class="p-6 sm:p-8 border-b border-white/10">
                        <div class="flex items-start justify-between">
                            <div>
                                <h3 class="text-2xl font-black"><span class="lang-en">Step 1: Shipping
                                        Details</span><span class="lang-si">පියවර 1: නැව්ගත කිරීමේ විස්තර</span></h3>
                                <p class="text-sm text-white/60"><span class="lang-en">Confirm your delivery
                                        information.</span><span class="lang-si">ඔබගේ බෙදාහැරීමේ තොරතුරු තහවුරු
                                        කරන්න.</span></p>
                            </div>
                            <button id="closeCheckoutModal"
                                class="text-white/60 hover:text-white transition-colors text-2xl -mt-2 -mr-2 p-2">×</button>
                        </div>
                    </div>
                    <form id="checkoutForm" class="flex-1 overflow-y-auto p-6 sm:p-8 space-y-4">
                        <!-- Form inputs remain the same -->
                        <div>
                            <label for="name" class="block text-sm font-medium mb-2"><span class="lang-en">Full
                                    Name</span><span class="lang-si">සම්පූර්ණ නම</span></label>
                            <input required type="text" id="name" name="name"
                                class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 placeholder-white/40 focus:outline-none focus:border-brand-400 focus:bg-white/10 transition-all">
                        </div>
                        <div class="grid sm:grid-cols-2 gap-4">
                            <div>
                                <label for="email" class="block text-sm font-medium mb-2"><span
                                        class="lang-en">Email</span><span class="lang-si">විද්යුත් තැපෑල</span></label>
                                <input required type="email" id="email" name="email"
                                    class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 placeholder-white/40 focus:outline-none focus:border-brand-400 focus:bg-white/10 transition-all">
                            </div>
                            <div>
                                <label for="phone" class="block text-sm font-medium mb-2"><span class="lang-en">Phone
                                        Number</span><span class="lang-si">දුරකථන අංකය</span></label>
                                <input required type="tel" id="phone" name="phone"
                                    class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 placeholder-white/40 focus:outline-none focus:border-brand-400 focus:bg-white/10 transition-all">
                            </div>
                        </div>
                        <div>
                            <label for="address_line1" class="block text-sm font-medium mb-2"><span
                                    class="lang-en">Address Line 1</span><span class="lang-si">ලිපිනය 1</span></label>
                            <input required type="text" id="address_line1" name="address_line1"
                                class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 placeholder-white/40 focus:outline-none focus:border-brand-400 focus:bg-white/10 transition-all">
                        </div>
                        <div>
                            <label for="address_line2" class="block text-sm font-medium mb-2"><span
                                    class="lang-en">Address Line 2 (Optional)</span><span class="lang-si">ලිපිනය 2
                                    (අත්‍යවශ්‍ය නොවේ)</span></label>
                            <input type="text" id="address_line2" name="address_line2"
                                class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 placeholder-white/40 focus:outline-none focus:border-brand-400 focus:bg-white/10 transition-all">
                        </div>
                        <div class="grid sm:grid-cols-2 gap-4">
                            <div>
                                <label for="city" class="block text-sm font-medium mb-2"><span
                                        class="lang-en">City</span><span class="lang-si">නගරය</span></label>
                                <input required type="text" id="city" name="city"
                                    class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 placeholder-white/40 focus:outline-none focus:border-brand-400 focus:bg-white/10 transition-all">
                            </div>
                            <div>
                                <label for="postal_code" class="block text-sm font-medium mb-2"><span
                                        class="lang-en">Postal Code</span><span class="lang-si">තැපැල්
                                        කේතය</span></label>
                                <input required type="text" id="postal_code" name="postal_code"
                                    class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 placeholder-white/40 focus:outline-none focus:border-brand-400 focus:bg-white/10 transition-all">
                            </div>
                        </div>
                    </form>
                    <div class="p-6 sm:p-8 border-t border-white/10">
                        <button id="btnConfirmDetails" type="submit" form="checkoutForm"
                            class="w-full shine px-6 py-3 rounded-xl bg-gradient-to-r from-brand-500 to-gold-400 text-white font-bold hover:shadow-xl transition-all disabled:opacity-60">
                            <span class="lang-en">Save & Choose Payment</span><span class="lang-si">තහවුරු කර ගෙවීම
                                තෝරන්න</span>
                        </button>
                        <p id="checkoutErrorStep1" class="text-xs text-red-400 text-center mt-3 hidden"></p>
                    </div>
                </div>

                <!-- STEP 2: Payment Method Selection -->
                <div id="checkoutStep2" class="hidden">
                    <div class="p-6 sm:p-8 border-b border-white/10">
                        <div class="flex items-start justify-between">
                            <div>
                                <h3 class="text-2xl font-black"><span class="lang-en">Step 2: Payment Method</span><span
                                        class="lang-si">පියවර 2: ගෙවීමේ ක්‍රමය</span></h3>
                                <p class="text-sm text-white/60"><span class="lang-en">How would you like to
                                        pay?</span><span class="lang-si">ඔබ ගෙවීමට කැමති කෙසේද?</span></p>
                            </div>
                            <button
                                class="close-checkout text-white/60 hover:text-white transition-colors text-2xl -mt-2 -mr-2 p-2">×</button>
                        </div>
                    </div>
                    <div class="p-6 sm:p-8 space-y-4">
                        <button id="btnGoToOnlinePayment"
                            class="w-full text-left p-4 rounded-xl bg-white/10 hover:bg-white/20 transition-all flex items-center gap-4 disabled:opacity-50">
                            <svg class="w-8 h-8 text-brand-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                fill="currentColor">
                                <path
                                    d="M20 4H4C2.89 4 2.01 4.89 2.01 6L2 18C2 19.11 2.89 20 4 20H20C21.11 20 22 19.11 22 18V6C22 4.89 21.11 4 20 4ZM20 18H4V8H20V18ZM4 6H20V6H4Z" />
                            </svg>
                            <div>
                                <div class="font-bold"><span class="lang-en">Online Payment</span><span
                                        class="lang-si">මාර්ගගත ගෙවීම</span></div>
                                <div class="text-sm text-white/70"><span class="lang-en">Pay with Credit/Debit Card,
                                        etc.</span><span class="lang-si">ක්‍රෙඩිට්/ඩෙබිට් කාඩ්පත සමඟ ගෙවන්න.</span>
                                </div>
                            </div>
                        </button>
                        <button id="btnGoToCod"
                            class="w-full text-left p-4 rounded-xl bg-white/10 hover:bg-white/20 transition-all flex items-center gap-4 disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-8 h-8 text-emerald-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                fill="currentColor">
                                <path
                                    d="M20 7V5H4V7H2V17H4V19H12V17H14V19H20V17H22V7H20ZM14.17 11.83L12 14L9.83 11.83L8.41 13.24L12 16.83L15.59 13.24L14.17 11.83ZM18 15H16V13H8V15H6V9H18V15Z" />
                            </svg>
                            <div>
                                <div class="font-bold"><span class="lang-en">Cash on Delivery (COD)</span><span
                                        class="lang-si">භාණ්ඩ ලැබුණු පසු මුදල්</span></div>
                                <div id="codMessage" class="text-sm text-white/70"><span class="lang-en">Pay at your
                                        doorstep.</span><span class="lang-si">ඔබේ දොරකඩදී ගෙවන්න.</span></div>
                            </div>
                        </button>
                    </div>
                    <div class="p-6 sm:p-8 border-t border-white/10 flex items-center justify-between">
                        <button id="btnBackToStep1"
                            class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15 font-semibold"><span
                                class="lang-en">Back</span><span class="lang-si">ආපසු</span></button>
                        <p id="checkoutErrorStep2" class="text-xs text-red-400 text-center hidden"></p>
                    </div>
                </div>

                <!-- STEP 3: COD Confirmation -->
                <div id="checkoutStep3" class="hidden">
                    <div class="p-6 sm:p-8 border-b border-white/10">
                        <div class="flex items-start justify-between">
                            <div>
                                <h3 class="text-2xl font-black"><span class="lang-en">Step 3: Confirm COD
                                        Order</span><span class="lang-si">පියවර 3: COD ඇණවුම තහවුරු කරන්න</span></h3>
                                <p class="text-sm text-white/60"><span class="lang-en">Please confirm the final
                                        amount.</span><span class="lang-si">කරුණාකර අවසාන මුදල තහවුරු කරන්න.</span></p>
                            </div>
                            <button
                                class="close-checkout text-white/60 hover:text-white transition-colors text-2xl -mt-2 -mr-2 p-2">×</button>
                        </div>
                    </div>
                    <div class="p-6 sm:p-8 text-center">
                        <p class="text-white/80"><span class="lang-en">You will pay</span><span class="lang-si">ඔබ ගෙවනු
                                ඇත</span></p>
                        <div id="cod-grand-total" class="text-4xl font-black my-2"></div>
                        <p class="text-sm text-white/70"><span class="lang-en">to the courier within 3 days at your
                                doorstep. Please keep the exact amount ready.</span><span class="lang-si">කුරියර් වෙත
                                දින 3ක් ඇතුළත ඔබේ දොරකඩදී. කරුණාකර නිශ්චිත මුදල සූදානම්ව තබා ගන්න.</span></p>
                    </div>
                    <div class="p-6 sm:p-8 border-t border-white/10">
                        <button id="btnConfirmCod"
                            class="w-full shine px-6 py-3 rounded-xl bg-gradient-to-r from-emerald-500 to-green-400 text-white font-bold hover:shadow-xl transition-all disabled:opacity-60">
                            <span class="lang-en">Confirm Order</span><span class="lang-si">ඇණවුම තහවුරු කරන්න</span>
                        </button>
                        <button id="btnBackToStep2"
                            class="w-full mt-3 px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15 font-semibold"><span
                                class="lang-en">Back to Payment Methods</span><span class="lang-si">ගෙවීම් ක්‍රම වෙත
                                ආපසු</span></button>
                        <p id="checkoutErrorStep3" class="text-xs text-red-400 text-center mt-3 hidden"></p>
                    </div>
                </div>

                <!-- STEP 4: Success Message -->
                <div id="checkoutStepSuccess" class="hidden">
                    <div class="p-6 sm:p-8 text-center">
                        <svg class="w-16 h-16 mx-auto text-emerald-400" xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                        </svg>
                        <h3 class="text-2xl font-black mt-4"><span class="lang-en">Order Placed!</span><span
                                class="lang-si">ඇණවුම තැන්පත් කරන ලදී!</span></h3>
                        <p class="text-white/80 mt-2"><span class="lang-en">Thank you for your purchase. We will process
                                your order shortly.</span><span class="lang-si">ඔබගේ මිලදී ගැනීමට ස්තූතියි. අපි ඔබගේ
                                ඇණවුම ഉടൻ ක්‍රියාත්මක කරන්නෙමු.</span></p>
                        <a href="{% url 'profile-page' %}"
                            class="mt-6 inline-block shine px-6 py-3 rounded-xl bg-gradient-to-r from-brand-500 to-gold-400 text-white font-bold hover:shadow-xl transition-all">
                            <span class="lang-en">View My Orders</span><span class="lang-si">මගේ ඇණවුම් බලන්න</span>
                        </a>
                    </div>
                </div>

            </div>
        </div>
    </div>


    <!-- =================================================================
    UPDATED SCRIPT SECTION
    ================================================================== -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- Utility Functions ---
            const fmt = (x) => (x === null || x === undefined) ? '0.00' : String(x);
            function getCookie(name) { const value = `; ${document.cookie}`.split(`; ${name}=`); if (value.length === 2) return value.pop().split(';').shift(); }
            const csrftoken = getCookie('csrftoken');

            // --- State Variables ---
            let currentGrandTotal = 0;
            let isCodApproved = false;

            const L = {
                en: { remove: 'Remove', removing: 'Removing…', removeDeviceConfirm: 'Remove the selected device and all games on it?', saving: 'Saving...', redirecting: 'Redirecting...', placingOrder: 'Placing Order...', confirmOrder: 'Confirm Order', choosePayment: 'Save & Choose Payment', fillAllFields: 'Please fill all required fields.', paymentFailed: 'Could not initiate payment.', codFinalizeFailed: 'Could not finalize COD order.', codMessageDisabled: 'Fulfil at least one order with online payment from us to be eligible for the COD feature.' },
                si: { remove: 'ඉවත් කරන්න', removing: 'ඉවත් කරමින්…', removeDeviceConfirm: 'තෝරාගත් උපාංගය සහ එහි ඇති සියලු ගේම් ඉවත් කරලෑද?', saving: 'සුරකිමින්...', redirecting: 'යොමු වෙමින්...', placingOrder: 'ඇණවුම තැන්පත් කරමින්...', confirmOrder: 'ඇණවුම තහවුරු කරන්න', choosePayment: 'තහවුරු කර ගෙවීම තෝරන්න', fillAllFields: 'කරුණාකර අවශ්‍ය සියලුම ක්ෂේත්‍ර පුරවන්න.', paymentFailed: 'ගෙවීම ආරම්භ කිරීමට නොහැකි විය.', codFinalizeFailed: 'COD ඇණවුම අවසන් කිරීමට නොහැකි විය.', codMessageDisabled: 'COD විශේෂාංගයට සුදුසුකම් ලැබීමට අපෙන් සබැඳි ගෙවීමක් සමඟ අවම වශයෙන් එක් ඇණවුමක්වත් සම්පූර්ණ කරන්න.' }
            };
            const getLang = () => (localStorage.getItem('language') === 'si' ? 'si' : 'en');
            const t = (k) => L[getLang()][k] || k;

            // --- Mobile Menu Logic (from home.html) ---
            const navToggle = document.getElementById('navToggle');
            const closeNav = document.getElementById('closeNav');
            const mobileMenuContainer = document.getElementById('mobileMenuContainer');
            const mobileMenu = document.getElementById('mobileMenu');
            const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
            const mobileMenuLinks = document.querySelectorAll('.mobile-menu-link');

            const openMenu = () => {
                mobileMenuContainer.classList.remove('pointer-events-none');
                mobileMenuOverlay.classList.remove('opacity-0');
                mobileMenu.classList.remove('translate-x-full');
                document.body.style.overflow = 'hidden';
            };
            const closeMenu = () => {
                mobileMenuOverlay.classList.add('opacity-0');
                mobileMenu.classList.add('translate-x-full');
                document.body.style.overflow = '';
                setTimeout(() => { mobileMenuContainer.classList.add('pointer-events-none'); }, 300);
            };

            navToggle.addEventListener('click', openMenu);
            closeNav.addEventListener('click', closeMenu);
            mobileMenuOverlay.addEventListener('click', closeMenu);
            mobileMenuLinks.forEach(link => link.addEventListener('click', closeMenu));
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !mobileMenuContainer.classList.contains('pointer-events-none')) {
                    closeMenu();
                }
            });

            // --- Cart Logic ---
            async function apiCall(url, options = {}) {
                const res = await fetch(url, { method: 'GET', credentials: 'same-origin', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken }, ...options });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({ detail: `Request failed with status ${res.status}` }));
                    throw new Error(err.detail || 'An unknown error occurred');
                }
                const contentType = res.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    return res.json();
                }
                return {};
            }


            function calculateShippingFee(directGamesCount, hasDevice) {
                if (!hasDevice && directGamesCount === 0) return 0;
                let fee = 350;
                if (directGamesCount > 3) fee += (directGamesCount - 3) * 50;
                return fee;
            }

            async function loadCart() {
                const data = await apiCall("{% url 'api_cart' %}");

                const devicePrice = parseFloat(data.storage_device_price || '0');
                const shippingFee = calculateShippingFee(data.left_items?.length || 0, !!data.device);
                currentGrandTotal = parseFloat(data.direct_total || '0') + devicePrice + shippingFee;

                document.getElementById('direct-total').textContent = `Rs ${fmt(parseFloat(data.direct_total || '0').toFixed(2))}`;
                document.getElementById('device-price').textContent = `Rs ${fmt(devicePrice.toFixed(2))}`;
                document.getElementById('shipping-fee').textContent = shippingFee > 0 ? `Rs ${fmt(shippingFee.toFixed(2))}` : '—';
                document.getElementById('grand-total').textContent = `Rs ${fmt(currentGrandTotal.toFixed(2))}`;
                document.getElementById('cod-grand-total').textContent = `Rs ${fmt(currentGrandTotal.toFixed(2))}`;

                document.getElementById('btnCheckout').disabled = currentGrandTotal - shippingFee <= 0;

                const capBlock = document.getElementById('capacity-block');
                if (data.device) {
                    capBlock.classList.remove('hidden');
                    const usedPct = Math.max(0, Math.min(100, parseFloat(data.device_percent_used || '0')));
                    document.getElementById('used-gb').textContent = fmt(parseFloat(data.device_used_gb || '0').toFixed(2));
                    document.getElementById('rem-gb').textContent = fmt(Math.max(0, (data.device.true_capacity_gb || 0) - (data.device_used_gb || 0)).toFixed(2));
                    document.getElementById('used-pct').textContent = String(Math.round(usedPct));
                    document.getElementById('bar').style.width = usedPct + '%';
                } else {
                    capBlock.classList.add('hidden');
                }
                renderCartItems(data);
            }

            function renderCartItems(data) {
                const productRow = (item, type) => {
                    const p = item.product;
                    const img = p.primary_image || "{% static 'images/cover-placeholder.jpg' %}";
                    const size = p.game_size_gb ? `${fmt(p.game_size_gb)} GB` : '';
                    const removeBtn = `<button class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/15 border border-red-500/30 text-red-200 text-sm" data-action="${type === 'left' ? 'remove-left' : 'remove-on-device'}" data-id="${item.id}">${t('remove')}</button>`;
                    return `
                        <article class="py-3 grid items-center gap-3" style="grid-template-columns: 64px 1fr auto ${type === 'left' ? 'auto' : ''};">
                            <img class="w-16 h-16 rounded-xl object-cover" src="${img}" alt="${p.title}">
                            <div>
                                <div class="font-semibold">${p.title}</div>
                                <div class="text-xs text-white/60">${type === 'left' ? `Qty: ${item.quantity}` : ''} ${size ? `• ${size}` : ''}</div>
                            </div>
                            ${type === 'left' ? `<div class="font-semibold">Rs ${fmt(item.subtotal)}</div>` : ''}
                            ${removeBtn}
                        </article>`;
                };
                document.getElementById('left-items').innerHTML = data.left_items?.length ? data.left_items.map(item => productRow(item, 'left')).join('') : `<p class="text-sm text-white/70">No direct purchases yet.</p>`;
                document.getElementById('right-items').innerHTML = data.right_items?.length ? data.right_items.map(item => productRow(item, 'right')).join('') : `<p class="text-sm text-white/70">No games on device.</p>`;
                document.getElementById('device-block').innerHTML = data.device ? `<div class="flex items-center gap-3"><img src="${data.device.image_url || ''}" class="w-16 h-20 object-cover rounded-xl"/><div class="font-semibold">${data.device.name}</div></div>` : `<p class="text-sm text-white/70">Select a device to add games for free.</p>`;
            }

            // --- Checkout Modal Logic ---
            const checkoutModal = document.getElementById('checkoutModal');
            const checkoutForm = document.getElementById('checkoutForm');

            const steps = {
                1: document.getElementById('checkoutStep1'),
                2: document.getElementById('checkoutStep2'),
                3: document.getElementById('checkoutStep3'),
                4: document.getElementById('checkoutStepSuccess')
            };

            function showCheckoutStep(stepNumber) {
                Object.values(steps).forEach(step => step.classList.add('hidden'));
                if (steps[stepNumber]) steps[stepNumber].classList.remove('hidden');

                if (stepNumber === 2) {
                    const btnCod = document.getElementById('btnGoToCod');
                    const codMessage = document.getElementById('codMessage');
                    btnCod.disabled = !isCodApproved;
                    if (!isCodApproved) {
                        codMessage.textContent = t('codMessageDisabled');
                        codMessage.classList.add('text-yellow-400');
                    } else {
                        codMessage.textContent = 'Pay at your doorstep.';
                        codMessage.classList.remove('text-yellow-400');
                    }
                }
            }

            function openCheckoutModal() {
                checkoutModal.classList.remove('hidden');
                showCheckoutStep(1);
                const confirmBtn = document.getElementById('btnConfirmDetails');
                confirmBtn.disabled = true;

                apiCall('/api/me').then(data => {
                    isCodApproved = data.is_cod_approved || false;
                    Object.keys(data).forEach(key => {
                        const el = checkoutForm.elements[key];
                        if (el) el.value = data[key] || '';
                    });
                }).finally(() => {
                    confirmBtn.disabled = false;
                });
            }

            function closeCheckoutModal() {
                checkoutModal.classList.add('hidden');
            }

            document.getElementById('btnCheckout')?.addEventListener('click', openCheckoutModal);
            document.querySelectorAll('.close-checkout, #closeCheckoutModal, #checkoutModalBackdrop').forEach(el => {
                el.addEventListener('click', closeCheckoutModal);
            });

            // Step 1: Submit shipping details
            checkoutForm?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const confirmBtn = document.getElementById('btnConfirmDetails');
                const errorEl = document.getElementById('checkoutErrorStep1');

                confirmBtn.disabled = true;
                confirmBtn.querySelector('span.lang-en').textContent = t('saving');
                confirmBtn.querySelector('span.lang-si').textContent = t('saving');
                errorEl.classList.add('hidden');

                try {
                    const data = Object.fromEntries(new FormData(checkoutForm).entries());
                    await apiCall('/api/me/update', { method: 'PATCH', body: JSON.stringify(data) });
                    showCheckoutStep(2);
                } catch (err) {
                    errorEl.textContent = err.message || t('fillAllFields');
                    errorEl.classList.remove('hidden');
                } finally {
                    confirmBtn.disabled = false;
                    confirmBtn.querySelector('span.lang-en').textContent = t('choosePayment');
                    confirmBtn.querySelector('span.lang-si').textContent = t('choosePayment');
                }
            });

            // Step 2 -> Online Payment
            document.getElementById('btnGoToOnlinePayment').addEventListener('click', async (e) => {
                const btn = e.currentTarget;
                const errorEl = document.getElementById('checkoutErrorStep2');
                btn.disabled = true;
                btn.querySelector('.font-bold .lang-en').textContent = t('redirecting');
                btn.querySelector('.font-bold .lang-si').textContent = t('redirecting');
                errorEl.classList.add('hidden');

                try {
                    const paymentData = await apiCall('/api/payments/genie/start', { method: 'POST', body: JSON.stringify({ amount: Math.round(currentGrandTotal * 100) }) });
                    if (paymentData.url) {
                        window.location.href = paymentData.url;
                    } else {
                        throw new Error('Payment URL not found.');
                    }
                } catch (err) {
                    errorEl.textContent = err.message || t('paymentFailed');
                    errorEl.classList.remove('hidden');
                    btn.disabled = false;
                    btn.querySelector('.font-bold .lang-en').textContent = 'Online Payment';
                    btn.querySelector('.font-bold .lang-si').textContent = 'මාර්ගගත ගෙවීම';
                }
            });

            // Step 2 -> COD
            document.getElementById('btnGoToCod').addEventListener('click', () => showCheckoutStep(3));

            // Step 3 -> Confirm COD
            document.getElementById('btnConfirmCod').addEventListener('click', async (e) => {
                const btn = e.currentTarget;
                const errorEl = document.getElementById('checkoutErrorStep3');
                btn.disabled = true;
                btn.querySelector('span.lang-en').textContent = t('placingOrder');
                btn.querySelector('span.lang-si').textContent = t('placingOrder');
                errorEl.classList.add('hidden');

                try {
                    await apiCall('/api/orders/cod-finalize/', { method: 'POST', body: JSON.stringify({ amount: Math.round(currentGrandTotal * 100) }) });
                    showCheckoutStep(4); // Show success step
                    loadCart(); // Refresh cart in background
                } catch (err) {
                    errorEl.textContent = err.message || t('codFinalizeFailed');
                    errorEl.classList.remove('hidden');
                    btn.disabled = false;
                    btn.querySelector('span.lang-en').textContent = t('confirmOrder');
                    btn.querySelector('span.lang-si').textContent = t('confirmOrder');
                }
            });

            // Back buttons
            document.getElementById('btnBackToStep1').addEventListener('click', () => showCheckoutStep(1));
            document.getElementById('btnBackToStep2').addEventListener('click', () => showCheckoutStep(2));


            // --- General Event Handlers ---
            document.addEventListener('click', async (e) => {
                const btn = e.target.closest('button[data-action]');
                if (!btn) return;
                const action = btn.dataset.action;
                const id = btn.dataset.id;
                btn.disabled = true; btn.textContent = t('removing');
                try {
                    if (action === 'remove-on-device') await apiCall("{% url 'api_cart_remove_from_device' %}", { method: 'POST', body: JSON.stringify({ storage_item_id: id }) });
                    if (action === 'remove-left') await apiCall("{% url 'api_remove_product_from_cart' %}", { method: 'POST', body: JSON.stringify({ item_id: id }) });
                    await loadCart();
                } catch (err) { alert(err.message); btn.disabled = false; btn.textContent = t('remove'); }
            });

            document.getElementById('btnRemoveDevice')?.addEventListener('click', async (e) => {
                if (!confirm(t('removeDeviceConfirm'))) return;
                const btn = e.target.closest('button');
                btn.disabled = true; btn.querySelector('span').textContent = t('removing');
                try {
                    await apiCall("{% url 'api_remove_storage_device_from_cart' %}", { method: 'POST' });
                    await loadCart();
                } catch (err) { alert(err.message); }
                finally { btn.disabled = false; btn.querySelector('span').textContent = t('remove'); }
            });

            // Initial Load
            loadCart().catch(console.error);
            document.getElementById('year').textContent = new Date().getFullYear();
        });

        // --- Language Toggle Logic ---
        document.addEventListener('DOMContentLoaded', function () {
            const langToggleBtn = document.getElementById('langToggleBtn');
            const langToggleBtnMobile = document.getElementById('langToggleBtnMobile');
            const body = document.body;
            const metaDescription = document.querySelector('meta[name="description"]');

            const setLanguage = (lang) => {
                const isSi = lang === 'si';
                body.classList.toggle('sinhala-mode', isSi);
                body.classList.toggle('font-sinhala', isSi);
                langToggleBtn.textContent = isSi ? 'EN' : 'සිංහල';
                document.title = isSi ? 'ඔබගේ කරත්තය — Virtual Lab Games' : 'Your Cart — Virtual Lab Games';
                metaDescription.setAttribute('content', isSi ? '...' : '...');
                localStorage.setItem('language', lang);
            };

            const toggleLanguage = () => {
                const newLang = (localStorage.getItem('language') || 'en') === 'en' ? 'si' : 'en';
                setLanguage(newLang);
                if (typeof loadCart === 'function') {
                    loadCart();
                }
            };

            langToggleBtn.addEventListener('click', toggleLanguage);
            langToggleBtnMobile.addEventListener('click', toggleLanguage);

            setLanguage(localStorage.getItem('language') || 'en');
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    {% load static %}
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Game Activation — Virtual Lab Games</title>
    <meta name="description" content="Activate your purchased offline games and manage your activation attempts." />

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#F1F7FF', 100: '#DDEBFF', 200: '#B8D5FF', 300: '#90BDFF', 400: '#5EA1FF', 500: '#2D86FF', 600: '#1E6CE0', 700: '#164FB3', 800: '#0E377F', 900: '#0A2559' },
                        gold: { 50: '#FFFBEB', 100: '#FEF3C7', 200: '#FDE68A', 300: '#FCD34D', 400: '#f6cd45', 500: '#F59E0B', 600: '#D97706', 700: '#B45309', 800: '#92400E', 900: '#78350F' }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4,0,0.6,1) infinite',
                        'gradient': 'gradient 8s ease infinite',
                        'slide-up': 'slideUp 0.3s ease-out',
                    },
                    keyframes: {
                        float: { '0%,100%': { transform: 'translateY(0px)' }, '50%': { transform: 'translateY(-20px)' } },
                        gradient: { '0%,100%': { 'background-position': '0% 50%' }, '50%': { 'background-position': '100% 50%' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600;700&family=Maname&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="{% static 'css/home.css' %}">

    <style>
        /* Language helpers */
        .lang-si {
            display: none;
        }

        body.sinhala-mode .lang-en {
            display: none;
        }

        body.sinhala-mode .lang-si {
            display: inline;
        }

        .block-lang.lang-si {
            display: none;
        }

        body.sinhala-mode .block-lang.lang-en {
            display: none;
        }

        body.sinhala-mode .block-lang.lang-si {
            display: block;
        }

        /* CSS for black and white image effect */
        .grayscale {
            filter: grayscale(100%);
        }
    </style>
</head>

<body class="bg-aurora text-white selection:bg-gold-400/30 selection:text-white noise">
    <header class="header-blend sticky top-0 z-[80]">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16 sm:h-18">
                <a href="{% url 'home-page' %}" class="flex items-center gap-2 sm:gap-3">
                    <img src="{% static 'images/Virtuallab.png' %}" alt="Virtual Lab logo"
                        class="h-10 sm:h-12 w-auto object-contain" width="48" height="48" decoding="async" />
                    <div class="flex flex-col">
                        <span class="font-black text-base sm:text-lg lg:text-xl tracking-tight">Virtual Lab</span>
                        <span class="text-[10px] sm:text-xs font-medium -mt-0.5">GAMES</span>
                    </div>
                </a>

                <nav class="hidden lg:flex items-center gap-6 xl:gap-8">
                    <a href="{% url 'home-page' %}"
                        class="text-sm font-semibold transition-colors hover:text-gold-400"><span
                            class="lang-en">Home</span><span class="lang-si">මුල් පිටුව</span></a>
                    <a href="{% url 'shop-page' %}"
                        class="text-sm font-semibold transition-colors hover:text-gold-400"><span
                            class="lang-en">Shop</span><span class="lang-si">වෙළඳසැල</span></a>
                    <a href="{% url 'blog_page' %}"
                        class="text-sm font-semibold transition-colors hover:text-gold-400"><span
                            class="lang-en">Blog</span><span class="lang-si">බ්ලොග්</span></a>
                    <a href="{% url 'tickets-page' %}"
                        class="text-sm font-semibold transition-colors hover:text-gold-400"><span
                            class="lang-en">Support</span><span class="lang-si">සහය</span></a>
                    <a href="{% url 'activation-page' %}"
                        class="text-sm font-semibold transition-colors text-gold-400"><span
                            class="lang-en">Activation</span><span class="lang-si">සක්‍රීය කිරීම</span></a>
                </nav>

                <div class="flex items-center gap-2 sm:gap-3">
                    <button id="langToggleBtn"
                        class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-white/10 hover:bg-white/15 text-sm font-bold transition-all">EN</button>
                    <a href="{% url 'cart_page' %}"
                        class="shine inline-flex items-center gap-1.5 sm:gap-2 px-3 sm:px-4 py-2 sm:py-2.5 rounded-xl bg-white/10 hover:bg-white/20 text-white text-xs sm:text-sm font-bold transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2 9m13-9l2 9M10 21a1 1 0 100-2 1 1 0 000 2zm8 0a1 1 0 100-2 1 1 0 000 2z" />
                        </svg>
                        <span class="hidden sm:inline"><span class="lang-en">Cart</span><span
                                class="lang-si">කරත්තය</span></span>
                    </a>
                    {% if user.is_authenticated %}
                    <a href="{% url 'profile-page' %}" aria-label="Account"
                        class="hidden lg:inline-flex items-center justify-center w-10 h-10 rounded-xl bg-white/10 hover:bg-white/15 font-bold uppercase transition-all">{{
                        user_initial }}</a>
                    {% else %}
                    <a href="{% url 'login-page' %}"
                        class="hidden lg:inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15 text-sm font-semibold transition-all"><span
                            class="lang-en">Login</span><span class="lang-si">ඇතුළු වන්න</span></a>
                    {% endif %}
                    <button id="navToggle"
                        class="lg:hidden p-2 rounded-lg bg-white/10 hover:bg-white/15 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="py-10 sm:py-14 lg:py-16">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">
            <div class="mb-6 sm:mb-8 text-center">
                <h1 class="text-3xl sm:text-4xl lg:text-5xl font-black">
                    <span class="block-lang lang-en">Game Activation Center</span>
                    <span class="block-lang lang-si">ගේම් සක්‍රීය කිරීමේ මධ්‍යස්ථානය</span>
                </h1>
                <p class="mt-2 max-w-2xl mx-auto text-white/70">
                    <span class="lang-en">Here you can activate your purchased games or buy new ones.</span>
                    <span class="lang-si">මෙතැනින් ඔබට මිලදී ගත් ගේම් සක්‍රීය කිරීමට හෝ නව ඒවා මිලදී ගැනීමට
                        හැකිය.</span>
                </p>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 sm:gap-6">
                {% for game_data in games_with_status %}
                <div
                    class="glass rounded-2xl p-4 flex flex-col text-center transition-all duration-300 hover:scale-105 hover:shadow-2xl">
                    <div class="relative mb-3">
                        <img src="{{ game_data.primary_image|default_if_none:'/static/images/cover-placeholder.jpg' }}"
                            alt="{{ game_data.product.title }}"
                            class="w-full aspect-[3/4] object-cover rounded-xl shadow-lg {% if game_data.user_status == 'not_owned' %}grayscale{% endif %}">

                        {% if game_data.user_status == 'owned' %}
                        <span
                            class="absolute top-2 right-2 text-xs font-bold bg-emerald-500/80 backdrop-blur-sm text-white px-2 py-1 rounded-full">
                            {{ game_data.ticket.remaining_attempts }} <span class="lang-en">attempts left</span><span
                                class="lang-si">වරක් ඉතිරි</span>
                        </span>
                        {% endif %}
                    </div>

                    <h3 class="font-bold text-lg leading-tight">{{ game_data.product.title }}</h3>

                    <div class="mt-2 text-sm flex-grow">
                        {% if game_data.user_status == 'owned' %}
                        <p class="font-semibold text-emerald-400"><span class="lang-en">Owned</span><span
                                class="lang-si">හිමිකාරීත්වය</span></p>
                        {% elif game_data.user_status == 'cod_pending' %}
                        <p class="font-semibold text-amber-400"><span class="lang-en">Cash on Delivery</span><span
                                class="lang-si">භාණ්ඩ ලැබුණු පසු මුදල්</span></p>
                        {% elif game_data.user_status == 'payment_pending' %}
                        <p class="font-semibold text-sky-400"><span class="lang-en">Payment Verifying</span><span
                                class="lang-si">ගෙවීම් සත්‍යාපනය</span></p>
                        {% else %}
                        <p class="font-mono font-bold text-lg">Rs 1500.00</p> {# Or use a custom text field from your
                        model #}
                        {% endif %}
                    </div>

                    <div class="mt-4">
                        {% if game_data.user_status == 'owned' %}
                        <a href="#"
                            class="w-full inline-block shine px-4 py-2.5 rounded-xl bg-gradient-to-r from-emerald-500 to-green-400 text-white font-bold shadow-lg hover:shadow-xl transition-all">
                            <span class="lang-en">Proceed</span><span class="lang-si">ඉදිරියට යන්න</span>
                        </a>
                        {% elif game_data.user_status == 'cod_pending' %}
                        <button data-action="show-cod-modal" data-game-id="{{ game_data.game.id }}"
                            class="w-full shine px-4 py-2.5 rounded-xl bg-gradient-to-r from-amber-500 to-yellow-400 text-white font-bold shadow-lg hover:shadow-xl transition-all">
                            <span class="lang-en">Activate</span><span class="lang-si">සක්‍රීය කරන්න</span>
                        </button>
                        {% elif game_data.user_status == 'payment_pending' %}
                        <button data-action="show-payment-info-modal"
                            class="w-full px-4 py-2.5 rounded-xl bg-white/10 hover:bg-white/20 text-sky-300 font-semibold transition-all">
                            <span class="lang-en">See More</span><span class="lang-si">තවත් බලන්න</span>
                        </button>
                        {% else %}
                        <button data-action="show-buy-now-modal" data-game-id="{{ game_data.game.id }}"
                            class="w-full shine px-4 py-2.5 rounded-xl bg-gradient-to-r from-brand-500 to-gold-400 text-white font-bold shadow-lg hover:shadow-xl transition-all">
                            <span class="lang-en">Buy Now</span><span class="lang-si">දැන් මිලදී ගන්න</span>
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </main>

    <footer class="mt-16 border-t border-white/10">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-10 text-center text-sm text-white/60">© <span
                id="year"></span> Virtual Lab Games.</div>
    </footer>

    <div id="codModal" class="fixed inset-0 z-[90] hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm modal-backdrop"></div>
        <div class="relative flex items-center justify-center min-h-screen p-4">
            <div class="glass rounded-3xl max-w-md w-full mx-auto">
                <div class="p-6 sm:p-8 border-b border-white/10">
                    <div class="flex items-start justify-between">
                        <div>
                            <h3 class="text-2xl font-black"><span class="lang-en">Enter Activation Code</span><span
                                    class="lang-si">සක්‍රීය කිරීමේ කේතය ඇතුළත් කරන්න</span></h3>
                            <p class="text-sm text-white/60"><span class="lang-en">Enter the 16-character code you
                                    received.</span><span class="lang-si">ඔබට ලැබුණු අක්ෂර 16 කේතය ඇතුළත් කරන්න.</span>
                            </p>
                        </div>
                        <button
                            class="modal-close-btn text-white/60 hover:text-white transition-colors text-2xl -mt-2 -mr-2 p-2">×</button>
                    </div>
                </div>
                <form id="codForm" class="p-6 sm:p-8 space-y-4">
                    <input type="hidden" name="game_id" id="cod_game_id">
                    <div>
                        <label for="activation_code" class="block text-sm font-medium mb-2"><span
                                class="lang-en">Activation Code</span><span class="lang-si">සක්‍රීය කිරීමේ
                                කේතය</span></label>
                        <input required type="text" id="activation_code" name="activation_code" maxlength="19"
                            placeholder="XXXX-XXXX-XXXX-XXXX"
                            class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 placeholder-white/40 focus:outline-none focus:border-brand-400 focus:bg-white/10 transition-all font-mono tracking-widest text-center">
                    </div>
                    <button type="submit"
                        class="w-full shine px-6 py-3 rounded-xl bg-gradient-to-r from-amber-500 to-yellow-400 text-white font-bold hover:shadow-xl transition-all disabled:opacity-60">
                        <span class="lang-en">Submit Code</span><span class="lang-si">කේතය ඉදිරිපත් කරන්න</span>
                    </button>
                    <p id="codError" class="text-xs text-red-400 text-center mt-3 hidden"></p>
                    <p id="codSuccess" class="text-xs text-emerald-400 text-center mt-3 hidden"></p>
                </form>
            </div>
        </div>
    </div>

    <div id="paymentInfoModal" class="fixed inset-0 z-[90] hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm modal-backdrop"></div>
        <div class="relative flex items-center justify-center min-h-screen p-4">
            <div class="glass rounded-3xl max-w-md w-full mx-auto text-center p-6 sm:p-8">
                <h3 class="text-2xl font-black"><span class="lang-en">Payment Verification In Progress</span><span
                        class="lang-si">ගෙවීම් සත්‍යාපනය වෙමින් පවතී</span></h3>
                <p class="text-white/80 mt-2"><span class="lang-en">Thank you for your payment. Give us 3 to 4 hours,
                        and we will confirm it. Your game will be available for activation shortly.</span><span
                        class="lang-si">ඔබගේ ගෙවීමට ස්තූතියි. අපට පැය 3-4ක් දෙන්න, අපි එය තහවුරු කරන්නෙමු. ඔබේ ගේම් එක
                        ඉක්මනින් සක්‍රීය කිරීමට හැකිවනු ඇත.</span></p>
                <button
                    class="modal-close-btn mt-6 shine px-6 py-2 rounded-xl bg-white/10 hover:bg-white/20 font-semibold transition-all">
                    <span class="lang-en">OK</span><span class="lang-si">හරි</span>
                </button>
            </div>
        </div>
    </div>

    <div id="buyNowModal" class="fixed inset-0 z-[90] hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm modal-backdrop"></div>
        <div class="relative flex items-center justify-center min-h-screen p-4">
            <div class="glass rounded-3xl max-w-md w-full mx-auto">
                <input type="hidden" name="game_id" id="buy_now_game_id">

                <div id="buyNowStep1">
                    <div class="p-6 sm:p-8 border-b border-white/10">
                        <div class="flex items-start justify-between">
                            <div>
                                <h3 class="text-2xl font-black"><span class="lang-en">Buy Now</span><span
                                        class="lang-si">දැන් මිලදී ගන්න</span></h3>
                                <p class="text-sm text-white/60"><span class="lang-en">Choose your payment
                                        method.</span><span class="lang-si">ඔබගේ ගෙවීමේ ක්‍රමය තෝරන්න.</span></p>
                            </div><button
                                class="modal-close-btn text-white/60 hover:text-white transition-colors text-2xl -mt-2 -mr-2 p-2">×</button>
                        </div>
                    </div>
                    <div class="p-6 sm:p-8 space-y-4">
                        <button data-action="go-to-buy-step2"
                            class="w-full text-left p-4 rounded-xl bg-white/10 hover:bg-white/20 transition-all flex items-center gap-4">
                            <svg class="w-8 h-8 text-brand-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                fill="currentColor">
                                <path
                                    d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" />
                            </svg>
                            <div>
                                <div class="font-bold"><span class="lang-en">Upload Bank Slip</span><span
                                        class="lang-si">බැංකු රිසිට්පත උඩුගත කරන්න</span></div>
                                <div class="text-sm text-white/70"><span class="lang-en">Pay via bank transfer and
                                        upload the receipt.</span><span class="lang-si">බැංකු මාරුවක් හරහා ගෙවා රිසිට්පත
                                        උඩුගත කරන්න.</span></div>
                            </div>
                        </button>
                    </div>
                </div>

                <div id="buyNowStep2" class="hidden">
                    <div class="p-6 sm:p-8 border-b border-white/10">
                        <div class="flex items-start justify-between">
                            <div>
                                <h3 class="text-2xl font-black"><span class="lang-en">Upload Slip</span><span
                                        class="lang-si">රිසිට්පත උඩුගත කරන්න</span></h3>
                                <p class="text-sm text-white/60"><span class="lang-en">Upload your payment confirmation
                                        slip.</span><span class="lang-si">ඔබගේ ගෙවීම් තහවුරු කිරීමේ රිසිට්පත උඩුගත
                                        කරන්න.</span></p>
                            </div><button
                                class="modal-close-btn text-white/60 hover:text-white transition-colors text-2xl -mt-2 -mr-2 p-2">×</button>
                        </div>
                    </div>
                    <form id="buyNowForm" class="p-6 sm:p-8 space-y-4">
                        <div>
                            <label for="payment_slip" class="block text-sm font-medium mb-2"><span
                                    class="lang-en">Payment Slip (Image)</span><span class="lang-si">ගෙවීම් රිසිට්පත
                                    (රූපය)</span></label>
                            <input required type="file" id="payment_slip" name="payment_slip"
                                accept="image/png, image/jpeg, image/jpg"
                                class="w-full text-sm text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-brand-500 file:text-white hover:file:bg-brand-600">
                        </div>
                        <div class="flex items-center gap-4">
                            <button type="button" data-action="go-to-buy-step1"
                                class="w-auto px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15 font-semibold"><span
                                    class="lang-en">Back</span><span class="lang-si">ආපසු</span></button>
                            <button type="submit"
                                class="w-full shine px-6 py-3 rounded-xl bg-gradient-to-r from-brand-500 to-gold-400 text-white font-bold hover:shadow-xl transition-all disabled:opacity-60">
                                <span class="lang-en">Submit for Verification</span><span class="lang-si">සත්‍යාපනය සඳහා
                                    ඉදිරිපත් කරන්න</span>
                            </button>
                        </div>
                        <p id="buyNowError" class="text-xs text-red-400 text-center mt-3 hidden"></p>
                    </form>
                </div>

            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- Utility Functions ---
            function getCookie(name) { const value = `; ${document.cookie}`.split(`; ${name}=`); if (value.length === 2) return value.pop().split(';').shift(); }
            const csrftoken = getCookie('csrftoken');

            async function apiCall(url, options = {}) {
                const defaultOptions = {
                    method: 'GET',
                    headers: { 'X-CSRFToken': csrftoken },
                };
                // If body is FormData, don't set Content-Type, browser will do it
                if (!(options.body instanceof FormData)) {
                    defaultOptions.headers['Content-Type'] = 'application/json';
                }

                const res = await fetch(url, { ...defaultOptions, ...options });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({ detail: `Request failed with status ${res.status}` }));
                    // Use a more specific error for unauthorized
                    if (res.status === 401) throw new Error("Unauthorized or invalid code.");
                    if (res.status === 404) throw new Error("The activation code was not found.");
                    throw new Error(err.detail || 'An unknown error occurred');
                }
                const contentType = res.headers.get("content-type");
                return (contentType && contentType.includes("application/json")) ? res.json() : {};
            }

            // --- Modal Management ---
            const modals = {
                cod: document.getElementById('codModal'),
                paymentInfo: document.getElementById('paymentInfoModal'),
                buyNow: document.getElementById('buyNowModal'),
            };

            function openModal(modalId) {
                if (modals[modalId]) {
                    modals[modalId].classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                }
            }

            function closeModal(modalId) {
                if (modals[modalId]) {
                    modals[modalId].classList.add('hidden');
                    document.body.style.overflow = '';
                }
            }

            // --- Global Event Listeners for Modals ---
            document.querySelectorAll('.modal-close-btn, .modal-backdrop').forEach(el => {
                el.addEventListener('click', () => {
                    Object.keys(modals).forEach(closeModal);
                });
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === "Escape") Object.keys(modals).forEach(closeModal);
            });

            // --- Main Click Handler ---
            document.body.addEventListener('click', function (e) {
                const button = e.target.closest('button[data-action]');
                if (!button) return;

                const action = button.dataset.action;
                const gameId = button.dataset.gameId;

                switch (action) {
                    case 'show-cod-modal':
                        document.getElementById('cod_game_id').value = gameId;
                        document.getElementById('codError').classList.add('hidden');
                        document.getElementById('codSuccess').classList.add('hidden');
                        document.getElementById('activation_code').value = '';
                        openModal('cod');
                        break;
                    case 'show-payment-info-modal':
                        openModal('paymentInfo');
                        break;
                    case 'show-buy-now-modal':
                        document.getElementById('buy_now_game_id').value = gameId;
                        document.getElementById('buyNowStep1').classList.remove('hidden');
                        document.getElementById('buyNowStep2').classList.add('hidden');
                        openModal('buyNow');
                        break;
                    case 'go-to-buy-step1':
                        document.getElementById('buyNowStep1').classList.remove('hidden');
                        document.getElementById('buyNowStep2').classList.add('hidden');
                        break;
                    case 'go-to-buy-step2':
                        document.getElementById('buyNowStep1').classList.add('hidden');
                        document.getElementById('buyNowStep2').classList.remove('hidden');
                        break;
                }
            });

            // --- Form Submission Handlers ---
            // COD Form
            const codForm = document.getElementById('codForm');
            codForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                const submitBtn = codForm.querySelector('button[type="submit"]');
                const errorEl = document.getElementById('codError');
                const successEl = document.getElementById('codSuccess');
                const formData = new FormData(codForm);
                const data = Object.fromEntries(formData.entries());

                submitBtn.disabled = true;
                errorEl.classList.add('hidden');
                successEl.classList.add('hidden');

                try {
                    // NOTE: Replace '/api/activation/verify-cod' with your actual API endpoint
                    await apiCall('/api/activation/verify-cod', {
                        method: 'POST',
                        body: JSON.stringify({ game_id: data.game_id, code: data.activation_code })
                    });
                    successEl.textContent = 'Code successfully confirmed! The page will now reload.';
                    successEl.classList.remove('hidden');
                    setTimeout(() => window.location.reload(), 2000);
                } catch (err) {
                    errorEl.textContent = err.message;
                    errorEl.classList.remove('hidden');
                } finally {
                    submitBtn.disabled = false;
                }
            });

            // Buy Now Form (Slip Upload)
            const buyNowForm = document.getElementById('buyNowForm');
            buyNowForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                const submitBtn = buyNowForm.querySelector('button[type="submit"]');
                const errorEl = document.getElementById('buyNowError');
                const gameId = document.getElementById('buy_now_game_id').value;

                const formData = new FormData();
                formData.append('game_id', gameId);
                formData.append('slip_image', document.getElementById('payment_slip').files[0]);

                submitBtn.disabled = true;
                errorEl.classList.add('hidden');

                try {
                    // NOTE: Replace '/api/activation/buy-with-slip' with your actual API endpoint
                    await apiCall('/api/activation/buy-with-slip', {
                        method: 'POST',
                        body: formData // Send as FormData for file upload
                    });
                    // On success, you might want to show a success message and reload
                    alert('Slip submitted successfully! We will verify it shortly.');
                    window.location.reload();
                } catch (err) {
                    errorEl.textContent = err.message;
                    errorEl.classList.remove('hidden');
                } finally {
                    submitBtn.disabled = false;
                }
            });

            // --- Auto-formatting for activation code input ---
            const codeInput = document.getElementById('activation_code');
            codeInput.addEventListener('input', function (e) {
                let value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                let formatted = '';
                for (let i = 0; i < value.length; i++) {
                    if (i > 0 && i % 4 === 0) formatted += '-';
                    formatted += value[i];
                }
                e.target.value = formatted;
            });

            // --- Initialization ---
            document.getElementById('year').textContent = new Date().getFullYear();
        });

        // --- Language Toggle Logic ---
        document.addEventListener('DOMContentLoaded', function () {
            // ... [The full language toggle JS from cart.html goes here] ...
        });

        // --- Mobile Menu Logic ---
        document.addEventListener('DOMContentLoaded', function () {
            // ... [The full mobile menu JS from cart.html goes here] ...
        });
    </script>
</body>

</html>